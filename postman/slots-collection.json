{
  "info": {
    "name": "Slots API - Full Regression",
    "description": "Postman collection for slot game API: Happy Path, Negative, Security. Use with dev.env.json.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3001"
    },
    {
      "key": "jwt_token",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "Auth",
      "description": "Authentication \u2014 register and login. Run Login first to populate jwt_token automatically.",
      "item": [
        {
          "name": "Register",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"password123\"\n}"
            },
            "url": "{{base_url}}/api/v1/auth/register",
            "description": "Register a new user. Returns access_token on success (201). Skip if already registered."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Register: Status 201\", () => pm.response.to.have.status(201));",
                  "pm.test(\"Register: Has access_token\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"access_token\");",
                  "  if (json.access_token) pm.environment.set(\"jwt_token\", json.access_token);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"password123\"\n}"
            },
            "url": "{{base_url}}/api/v1/auth/login",
            "description": "Login with email and password. Automatically saves access_token to jwt_token environment variable."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Login: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"Login: Has access_token\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"access_token\");",
                  "  if (json.access_token) {",
                  "    pm.environment.set(\"jwt_token\", json.access_token);",
                  "    console.log(\"jwt_token saved to environment\");",
                  "  }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Register \u2014 duplicate email",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/auth/register",
            "description": "Second register with the same email \u2192 409 email_taken.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"password123\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Register duplicate: Status 409\", () => pm.response.to.have.status(409));",
                  "pm.test(\"Register duplicate: code = email_taken\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"email_taken\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Register \u2014 invalid body",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/auth/register",
            "description": "Missing password field \u2192 400 invalid_body.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"not-an-email\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Register invalid body: Status 400\", () => pm.response.to.have.status(400));",
                  "pm.test(\"Register invalid body: code = invalid_body\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"invalid_body\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Login \u2014 wrong password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/auth/login",
            "description": "Correct email, wrong password \u2192 401 invalid_credentials.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"wrong_password_xyz\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Login wrong password: Status 401\", () => pm.response.to.have.status(401));",
                  "pm.test(\"Login wrong password: code = invalid_credentials\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"invalid_credentials\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Login \u2014 missing body",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/auth/login",
            "description": "Empty body \u2192 400 invalid_body."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Login missing body: Status 400\", () => pm.response.to.have.status(400));",
                  "pm.test(\"Login missing body: code = invalid_body\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"invalid_body\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Token Refresh \u2014 valid",
          "request": {
            "method": "POST",
            "header": [],
            "url": "{{base_url}}/api/v1/auth/refresh",
            "description": "Uses the refresh_token cookie set by Login. Returns new access_token and rotates the refresh cookie."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Refresh valid: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"Refresh valid: Has access_token\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"access_token\");",
                  "  pm.expect(json).to.have.property(\"expires_in\");",
                  "  if (json.access_token) pm.environment.set(\"jwt_token\", json.access_token);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Token Refresh \u2014 no cookie",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "",
                "type": "text",
                "description": "Deliberately empty \u2014 overrides cookie jar for this request"
              }
            ],
            "url": "{{base_url}}/api/v1/auth/refresh",
            "description": "No refresh_token cookie \u2192 401 missing_refresh_token."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Refresh no cookie: Status 401\", () => pm.response.to.have.status(401));",
                  "pm.test(\"Refresh no cookie: code = missing_refresh_token\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"missing_refresh_token\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Logout",
          "request": {
            "method": "POST",
            "header": [],
            "url": "{{base_url}}/api/v1/auth/logout",
            "description": "Revokes all refresh tokens for the user and clears the cookie. After this, Token Refresh will return 401."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Logout: Status 204\", () => pm.response.to.have.status(204));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Happy Path",
      "item": [
        {
          "name": "TC-01: Successful game initialization",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"game_id\": \"{{game_id}}\",\n  \"platform\": \"web\",\n  \"locale\": \"en\",\n  \"client_version\": \"1.2.0\"\n}"
            },
            "url": "{{base_url}}/api/v1/game/init",
            "description": "Successful game initialization. Expects 200, config with min/max bet, session_id, balance."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-01: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-01: Has session_id\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"session_id\");",
                  "  if (json.session_id) pm.environment.set(\"session_id\", json.session_id);",
                  "});",
                  "pm.test(\"TC-01: Has config with limits\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"config\");",
                  "  pm.expect(json.config).to.have.property(\"min_bet\");",
                  "  pm.expect(json.config).to.have.property(\"max_bet\");",
                  "});",
                  "pm.test(\"TC-01: Has balance\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"balance\");",
                  "  pm.expect(json.balance).to.have.property(\"amount\");",
                  "  pm.expect(json.balance).to.have.property(\"currency\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-02: Spin with valid bet \u2014 200 + outcome",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{$guid}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": {\n    \"amount\": 1.00,\n    \"currency\": \"USD\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Spin with valid bet. Expects 200, spin_id, outcome (reel_matrix, win), balance."
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Save balance before spin for TC-03",
                  "const initRes = pm.response || {};",
                  "if (pm.environment.get('balance_before_spin') === undefined || pm.info.requestName.indexOf('TC-02') >= 0) {",
                  "  pm.environment.set('idempotency_key', pm.variables.replaceIn('{{$guid}}'));",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-02: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-02: Has spin_id\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"spin_id\");",
                  "  pm.environment.set(\"last_spin_id\", json.spin_id);",
                  "});",
                  "pm.test(\"TC-02: Has outcome\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"outcome\");",
                  "  pm.expect(json.outcome).to.have.property(\"reel_matrix\");",
                  "  pm.expect(json.outcome).to.have.property(\"win\");",
                  "  pm.expect(json.outcome.win).to.have.property(\"amount\");",
                  "});",
                  "pm.test(\"TC-02: Has balance\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"balance\");",
                  "  pm.expect(json.balance.amount).to.be.a(\"number\");",
                  "  pm.environment.set(\"last_balance_amount\", String(json.balance.amount));",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-03: Win \u2014 balance delta equals -bet + win",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{$guid}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": {\n    \"amount\": 0.50,\n    \"currency\": \"USD\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Validates: balance_after = balance_before - bet + win. Saves balance before spin in prerequest, then verifies the formula."
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Store balance from last response if available (e.g. from TC-02); otherwise skip balance delta test",
                  "const lastBalance = pm.environment.get('last_balance_amount');",
                  "if (!lastBalance) pm.environment.set('last_balance_amount', '0');"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-03: Status 200\", () => pm.response.to.have.status(200));",
                  "const json = pm.response.json();",
                  "const bet = 0.50;",
                  "const balanceAfter = json.balance && json.balance.amount;",
                  "const winAmount = json.outcome && json.outcome.win && json.outcome.win.amount || 0;",
                  "pm.environment.set(\"last_balance_amount\", String(balanceAfter));",
                  "pm.test(\"TC-03: Balance is number\", () => pm.expect(balanceAfter).to.be.a(\"number\"));",
                  "pm.test(\"TC-03: Balance delta = -bet + win\", () => {",
                  "  const before = parseFloat(pm.environment.get('last_balance_amount') || '0');",
                  "  if (pm.info.iteration === 0 || before > 0) {",
                  "    const expectedDelta = -bet + winAmount;",
                  "    pm.expect(balanceAfter - before).to.equal(expectedDelta);",
                  "  }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-04: Free Spins bonus trigger",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{$guid}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": {\n    \"amount\": 1.00,\n    \"currency\": \"USD\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Spin; if a bonus triggers, outcome contains bonus_triggered. Test validates response structure. Actual bonus trigger is probabilistic \u2014 run multiple times or mock on the backend."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-04: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-04: Outcome structure allows bonus\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"outcome\");",
                  "  if (json.outcome.bonus_triggered) {",
                  "    pm.expect(json.outcome.bonus_triggered).to.have.property(\"type\");",
                  "    pm.expect(json.outcome.bonus_triggered).to.satisfy(t => t.type === \"free_spins\" || t.type === \"bonus\");",
                  "  }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-15: GET /history \u2014 own data",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/history?limit=10&offset=0",
              "query": [
                {
                  "key": "limit",
                  "value": "10"
                },
                {
                  "key": "offset",
                  "value": "0"
                }
              ]
            },
            "description": "Returns the authenticated user's spin history. Validates response shape."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-15: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-15: Has items array and total\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"items\");",
                  "  pm.expect(json.items).to.be.an(\"array\");",
                  "  pm.expect(json).to.have.property(\"total\");",
                  "  pm.expect(json).to.have.property(\"limit\");",
                  "  pm.expect(json).to.have.property(\"offset\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-16: GET /history \u2014 pagination",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/history?limit=2&offset=0",
              "query": [
                {
                  "key": "limit",
                  "value": "2"
                },
                {
                  "key": "offset",
                  "value": "0"
                }
              ]
            },
            "description": "Validates pagination: limit=2 returns at most 2 items, limit field echoed correctly."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-16: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-16: Pagination respected\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json.items.length).to.be.at.most(2);",
                  "  pm.expect(json.limit).to.eql(2);",
                  "  pm.expect(json.offset).to.eql(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Negative Testing",
      "item": [
        {
          "name": "TC-05: Spin without Authorization \u2014 401",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": 1, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Request without Authorization header. Expects 401 Unauthorized."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-05: Status 401\", () => pm.response.to.have.status(401));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-06: Spin with insufficient balance \u2014 422",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "zero-balance-{{$guid}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": 999999, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Bet exceeds balance (or a user with zero balance). Expects 422 and error code insufficient_balance."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-06: Status 422\", () => pm.response.to.have.status(422));",
                  "pm.test(\"TC-06: Error code insufficient_balance\", () => {",
                  "  const json = pm.response.json();",
                  "  const code = json.code || json.error || json.message || \"\";",
                  "  const codeStr = typeof code === 'string' ? code : (json.error_code || '');",
                  "  pm.expect(JSON.stringify(json).toLowerCase()).to.include(\"insufficient\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-07: Negative bet amount = -100 \u2014 400",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "neg-bet-{{$guid}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": -100, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Negative bet amount. Expects 400 Bad Request."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-07: Status 400\", () => pm.response.to.have.status(400));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-08: Duplicate spin with same idempotency_key \u2014 200 or 409",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "replay-fixed-key-12345",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": 1, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "First request with a fixed Idempotency-Key. Second request with the same key: expects 409 Conflict OR 200 with the same spin_id (idempotent response)."
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Fixed Idempotency-Key so 2nd run returns 409 or same 200 body"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Accept either 409 (duplicate) or 200 with same spin_id (idempotent success)",
                  "const status = pm.response.code;",
                  "pm.test(\"TC-08: Status 409 or 200\", () => pm.expect([200, 409]).to.include(status));",
                  "if (status === 409) {",
                  "  pm.test(\"TC-08: 409 body indicates duplicate\", () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.be.an('object');",
                  "  });",
                  "} else if (status === 200) {",
                  "  const spinId = pm.response.json().spin_id;",
                  "  const firstId = pm.environment.get('idempotency_first_spin_id');",
                  "  if (!firstId) pm.environment.set('idempotency_first_spin_id', spinId);",
                  "  else pm.test(\"TC-08: 200 idempotent \u2014 same spin_id when key reused\", () => pm.expect(spinId).to.equal(firstId));",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-09: JWT alg none \u2014 401",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzdWIiOiI5OTk5OSIsInNlc3Npb25faWQiOiJmYWtlIn0.",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": 1, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "JWT with alg: none and forged payload. Expects 401."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-09: Status 401\", () => pm.response.to.have.status(401));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-10: IDOR \u2014 another user's history \u2014 403",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/history?user_id=99999&limit=10",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "v1",
                "history"
              ],
              "query": [
                {
                  "key": "user_id",
                  "value": "99999"
                },
                {
                  "key": "limit",
                  "value": "10"
                }
              ]
            },
            "description": "Request history using another user's user_id. Expects 403 Forbidden or 200 with own data only (server ignores user_id param and returns the authenticated user's data)."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Either 403 or 200 with only own data (no other user's spins)",
                  "const status = pm.response.code;",
                  "pm.test(\"TC-10: Status 403 or 200 with own data only\", () => pm.expect([403, 200]).to.include(status));",
                  "if (status === 200) {",
                  "  pm.test(\"TC-10: No foreign user_id in items\", () => {",
                  "    const json = pm.response.json();",
                  "    const items = json.items || [];",
                  "    items.forEach(item => {",
                  "      if (item.user_id) pm.expect(String(item.user_id)).to.equal(pm.environment.get('user_id'));",
                  "    });",
                  "  });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-17: GET /history \u2014 no auth",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url}}/api/v1/history",
            "description": "No Authorization header \u2192 401."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-17: Status 401\", () => pm.response.to.have.status(401));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-18: POST /spin \u2014 expired session",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/spin",
            "description": "Invalid session_id \u2192 403 session_expired.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"invalid-session-does-not-exist-999\",\n  \"game_id\": \"slot_mega_fortune_001\",\n  \"bet\": {\n    \"amount\": 1.0,\n    \"currency\": \"USD\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": 0\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-18: Status 403\", () => pm.response.to.have.status(403));",
                  "pm.test(\"TC-18: code = session_expired\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"session_expired\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-19: POST /spin \u2014 wrong game_id",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/spin",
            "description": "game_id does not match the session's game \u2192 400 invalid_game_id.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"slot_wrong_game_id_999\",\n  \"bet\": {\n    \"amount\": 1.0,\n    \"currency\": \"USD\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": 0\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-19: Status 400\", () => pm.response.to.have.status(400));",
                  "pm.test(\"TC-19: code = invalid_game_id\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"invalid_game_id\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-20: POST /spin \u2014 bet below min (0.001)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/spin",
            "description": "Bet amount 0.001 is below MIN_BET (0.1) \u2192 422 invalid_bet.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"slot_mega_fortune_001\",\n  \"bet\": {\n    \"amount\": 0.001,\n    \"currency\": \"USD\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": 0\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-20: Status 422\", () => pm.response.to.have.status(422));",
                  "pm.test(\"TC-20: code = invalid_bet\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"invalid_bet\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-21: POST /spin \u2014 invalid currency",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/spin",
            "description": "currency EUR is not supported (only USD) \u2192 422 invalid_currency.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"slot_mega_fortune_001\",\n  \"bet\": {\n    \"amount\": 1.0,\n    \"currency\": \"EUR\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": 0\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-21: Status 422\", () => pm.response.to.have.status(422));",
                  "pm.test(\"TC-21: code = invalid_currency\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"invalid_currency\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-22: POST /spin \u2014 invalid lines count",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/spin",
            "description": "lines = 0 is outside valid range (1\u201320) \u2192 422 invalid_lines.",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"slot_mega_fortune_001\",\n  \"bet\": {\n    \"amount\": 1.0,\n    \"currency\": \"USD\",\n    \"lines\": 0\n  },\n  \"client_timestamp\": 0\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-22: Status 422\", () => pm.response.to.have.status(422));",
                  "pm.test(\"TC-22: code = invalid_lines\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"invalid_lines\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-23: POST /spin \u2014 idempotency key reused with different payload",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idempotency_key}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"slot_mega_fortune_001\",\n  \"bet\": {\n    \"amount\": 2.0,\n    \"currency\": \"USD\",\n    \"lines\": 20\n  },\n  \"client_timestamp\": 0\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Reuses the idempotency_key from TC-08 but with a different bet amount (2.0 vs 1.0). Payload mismatch must return 409 idempotency_key_reused."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-23: Status 409\", () => pm.response.to.have.status(409));",
                  "pm.test(\"TC-23: code = idempotency_key_reused\", () => {",
                  "  pm.expect(pm.response.json().code).to.eql(\"idempotency_key_reused\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Security Testing",
      "item": [
        {
          "name": "TC-11: SQL Injection in bet_amount",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "sqli-{{$guid}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": \"1; DROP TABLE spins;--\", \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "SQL injection in bet.amount field. Expects 400/422; request must not execute SQL. The amount type must be validated as a number on the backend."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-11: Status 4xx (no 200)\", () => pm.expect(pm.response.code).to.be.at.least(400));",
                  "pm.test(\"TC-11: No 500 server error\", () => pm.expect(pm.response.code).to.be.below(500));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-12: XSS in session_id",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "xss-{{$guid}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"<script>alert(1)</script>\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": 1, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "XSS payload in session_id. Expects 400/422 (invalid session); response body must not contain an unescaped script tag."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-12: Status 4xx\", () => pm.expect(pm.response.code).to.be.at.least(400));",
                  "pm.test(\"TC-12: Response body has no raw script tag\", () => {",
                  "  const text = pm.response.text();",
                  "  pm.expect(text).to.not.match(/<script\\s*>/i);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-13: Rate limit \u2014 50 spins per second",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "rate-{{$guid}}-{{$randomInt}}",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": 0.10, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": {{$timestamp}}\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "Send 50+ requests per second (via Collection Runner with iterations or a separate script). Expects 429 after N spins. A single request here only validates the response structure; the full rate limit test requires 50+ Runner iterations."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const code = pm.response.code;",
                  "pm.test(\"TC-13: Status 200 or 429\", () => pm.expect([200, 429]).to.include(code));",
                  "if (code === 429) {",
                  "  pm.test(\"TC-13: 429 has Retry-After or rate limit message\", () => {",
                  "    const hasRetry = pm.response.headers.has('Retry-After');",
                  "    const body = pm.response.json();",
                  "    const msg = (body.message || body.error || '').toLowerCase();",
                  "    pm.expect(hasRetry || msg.includes('rate') || msg.includes('limit')).to.be.true;",
                  "  });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-14: Replay attack \u2014 replayed intercepted request",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Idempotency-Key",
                "value": "replay-attack-fixed-key-12345",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"session_id\": \"{{session_id}}\",\n  \"game_id\": \"{{game_id}}\",\n  \"bet\": { \"amount\": 1, \"currency\": \"USD\", \"lines\": 20 },\n  \"client_timestamp\": 1708851234000\n}"
            },
            "url": "{{base_url}}/api/v1/spin",
            "description": "First request with a fixed Idempotency-Key \u2014 200 and spin_id. Second request (replay) with the same key: must return 200 with the same spin_id (idempotency) or 409. No double debit or double win should occur."
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "if (!pm.environment.get('replay_first_spin_id')) {",
                  "  pm.environment.set('replay_first_spin_id', '');",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const json = pm.response.json();",
                  "const code = pm.response.code;",
                  "const spinId = json.spin_id;",
                  "const firstId = pm.environment.get('replay_first_spin_id');",
                  "if (!firstId && spinId) pm.environment.set('replay_first_spin_id', spinId);",
                  "pm.test(\"TC-14: Status 200 or 409\", () => pm.expect([200, 409]).to.include(code));",
                  "if (code === 200 && firstId && spinId) {",
                  "  pm.test(\"TC-14: Replay returns same spin_id (no double execution)\", () => pm.expect(spinId).to.equal(firstId));",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "History & Provably Fair",
      "description": "Game history queries with filters, round detail inspection, and provably fair seed management.",
      "item": [
        {
          "name": "TC-24: GET /history with date filter",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/game/history?date_from=2020-01-01T00:00:00Z&date_to=2030-12-31T23:59:59Z",
              "query": [
                {
                  "key": "date_from",
                  "value": "2020-01-01T00:00:00Z"
                },
                {
                  "key": "date_to",
                  "value": "2030-12-31T23:59:59Z"
                }
              ]
            },
            "description": "Fetch game history filtered by date range. Expects 200 with items array and pagination metadata."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-24: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-24: Has items array\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"items\");",
                  "  pm.expect(json.items).to.be.an(\"array\");",
                  "});",
                  "pm.test(\"TC-24: Has pagination fields\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"total\");",
                  "  pm.expect(json).to.have.property(\"limit\");",
                  "  pm.expect(json).to.have.property(\"offset\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-25: GET /history with result=win",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/game/history?result=win",
              "query": [
                {
                  "key": "result",
                  "value": "win"
                }
              ]
            },
            "description": "Fetch game history filtered by result=win. Expects 200 with items array containing only winning rounds."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-25: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-25: Has items array\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"items\");",
                  "  pm.expect(json.items).to.be.an(\"array\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-26: GET /history with min_bet/max_bet",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/game/history?min_bet=0.10&max_bet=100",
              "query": [
                {
                  "key": "min_bet",
                  "value": "0.10"
                },
                {
                  "key": "max_bet",
                  "value": "100"
                }
              ]
            },
            "description": "Fetch game history filtered by bet amount range. Expects 200 with items within the specified bet range."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-26: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-26: Has items array\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"items\");",
                  "  pm.expect(json.items).to.be.an(\"array\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-27: GET /history/summary",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/game/history/summary",
            "description": "Fetch aggregate summary of the user's game history. Expects 200 with total_rounds, total_wagered, total_won, net_result, biggest_win."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-27: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-27: Has summary fields\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"total_rounds\");",
                  "  pm.expect(json).to.have.property(\"total_wagered\");",
                  "  pm.expect(json).to.have.property(\"total_won\");",
                  "  pm.expect(json).to.have.property(\"net_result\");",
                  "  pm.expect(json).to.have.property(\"biggest_win\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-28: GET /history/:roundId",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/game/history/{{round_id}}",
            "description": "Fetch detail for a specific round. Requires round_id variable (set from a prior spin's spin_id). Expects 200 with reel_matrix, transactions, and outcome_hash."
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// round_id must be set from a prior spin response (spin_id = round UUID).",
                  "// If not set, fall back to last_spin_id from TC-02.",
                  "if (!pm.environment.get('round_id')) {",
                  "  const lastSpinId = pm.environment.get('last_spin_id');",
                  "  if (lastSpinId) pm.environment.set('round_id', lastSpinId);",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-28: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-28: Has reel_matrix\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"reel_matrix\");",
                  "});",
                  "pm.test(\"TC-28: Has transactions\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"transactions\");",
                  "});",
                  "pm.test(\"TC-28: Has outcome_hash\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"outcome_hash\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-29: GET /history/:roundId invalid UUID",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/game/history/not-a-valid-uuid",
            "description": "Fetch round detail with an invalid UUID. Expects 404 Not Found."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-29: Status 404\", () => pm.response.to.have.status(404));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-30: GET /provably-fair/current",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/game/provably-fair/current",
            "description": "Fetch the current provably fair seed pair. Expects 200 with server_seed_hash present and server_seed absent (not revealed until rotation)."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-30: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-30: Has server_seed_hash\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"server_seed_hash\");",
                  "});",
                  "pm.test(\"TC-30: server_seed is not revealed\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.not.have.property(\"server_seed\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-31: POST /provably-fair/rotate",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              }
            ],
            "url": "{{base_url}}/api/v1/game/provably-fair/rotate",
            "description": "Rotate seed pair. Expects 200 with previous.server_seed revealed and current.server_seed_hash for the new pair."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-31: Status 200\", () => pm.response.to.have.status(200));",
                  "pm.test(\"TC-31: Previous server_seed revealed\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"previous\");",
                  "  pm.expect(json.previous).to.have.property(\"server_seed\");",
                  "});",
                  "pm.test(\"TC-31: Current has server_seed_hash\", () => {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property(\"current\");",
                  "  pm.expect(json.current).to.have.property(\"server_seed_hash\");",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-32: PUT /provably-fair/client-seed (valid)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"client_seed\": \"my-test-seed-123\"\n}"
            },
            "url": "{{base_url}}/api/v1/game/provably-fair/client-seed",
            "description": "Set a valid client seed. Expects 200 confirming the seed was updated."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-32: Status 200\", () => pm.response.to.have.status(200));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "TC-33: PUT /provably-fair/client-seed (invalid)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"client_seed\": \"\"\n}"
            },
            "url": "{{base_url}}/api/v1/game/provably-fair/client-seed",
            "description": "Set an empty client seed. Expects 400 validation error."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"TC-33: Status 400\", () => pm.response.to.have.status(400));"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    }
  ]
}