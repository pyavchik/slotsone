<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQL Reference — pyavchik.space</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(180deg, #0f1118 0%, #0b0d13 100%);
        color: #f8fafc;
        min-height: 100vh;
        font-size: 14px;
      }

      .wrap {
        max-width: 1080px;
        margin: 0 auto;
        padding: 28px 18px 56px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* ── Cards ───────────────────────────────────── */
      .card {
        border: 1px solid rgba(255,255,255,0.13);
        border-radius: 14px;
        background: rgba(17,20,30,0.78);
        padding: 20px 22px;
      }

      h1 { margin: 0 0 3px; font-size: 26px; letter-spacing: -.3px; }
      .subtitle { margin: 0 0 14px; color: #94a3b8; font-size: 13px; }
      h2 { margin: 0 0 14px; font-size: 16px; color: #f1f5f9; }
      h3 { margin: 0 0 10px; font-size: 14px; color: #e2e8f0; }
      p  { margin: 0 0 10px; color: #dbe2ec; line-height: 1.55; }

      /* ── Back link ───────────────────────────────── */
      .back {
        display: inline-flex; align-items: center; gap: 6px;
        font-size: 13px; font-weight: 600; color: #94a3b8;
        text-decoration: none;
        border: 1px solid rgba(148,163,184,.3);
        padding: 6px 12px; border-radius: 8px;
        background: rgba(15,23,42,.5);
        width: fit-content;
      }
      .back:hover { color: #f8fafc; border-color: rgba(148,163,184,.7); }

      /* ── Stats ───────────────────────────────────── */
      .stats { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .stat {
        padding: 8px 14px; border-radius: 10px;
        background: rgba(15,23,42,.65);
        border: 1px solid rgba(148,163,184,.2);
        font-size: 13px; color: #dbe2ec; text-align: center;
      }
      .stat strong { display: block; font-size: 22px; line-height: 1.15; color: #f8fafc; }

      /* ── ERD Tables ─────────────────────────────── */
      .erd-wrap {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 0;
        align-items: start;
        margin-bottom: 16px;
      }
      .erd-table {
        border: 1px solid rgba(148,163,184,.25);
        border-radius: 10px;
        overflow: hidden;
        background: rgba(15,23,42,.55);
      }
      .erd-table-head {
        padding: 10px 14px;
        background: rgba(15,23,42,.8);
        border-bottom: 1px solid rgba(148,163,184,.2);
        font-weight: 700; font-size: 14px;
        display: flex; align-items: center; gap: 8px;
      }
      .erd-table-head .tbl-icon {
        width: 18px; height: 18px; border-radius: 4px;
        display: inline-flex; align-items: center; justify-content: center;
        font-size: 10px; font-weight: 800;
      }
      .erd-tbl-users .tbl-icon { background: rgba(56,189,248,.2); color: #38bdf8; }
      .erd-tbl-tokens .tbl-icon { background: rgba(245,208,106,.2); color: #f5d06a; }
      .erd-tbl-wallets .tbl-icon { background: rgba(62,224,169,.2); color: #3ee0a9; }
      .erd-tbl-seeds .tbl-icon { background: rgba(167,139,250,.2); color: #a78bfa; }
      .erd-tbl-rounds .tbl-icon { background: rgba(251,146,60,.2); color: #fb923c; }
      .erd-tbl-txns .tbl-icon { background: rgba(248,113,113,.2); color: #f87171; }

      .erd-cols { width: 100%; border-collapse: collapse; }
      .erd-cols td {
        padding: 6px 14px;
        border-bottom: 1px solid rgba(255,255,255,.05);
        font-size: 13px; color: #dbe2ec;
        vertical-align: top;
      }
      .erd-cols tr:last-child td { border-bottom: none; }
      .erd-col-name {
        font-family: ui-monospace, monospace; font-size: 12px;
        color: #f1f5f9; white-space: nowrap;
      }
      .erd-col-type {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #3ee0a9; white-space: nowrap;
      }
      .erd-col-constraint {
        font-size: 10px; font-weight: 700; letter-spacing: .03em;
        white-space: nowrap;
      }
      .erd-pk { color: #38bdf8; }
      .erd-fk { color: #f87171; }
      .erd-uq { color: #a78bfa; }
      .erd-nn { color: #64748b; }
      .erd-def { color: #94a3b8; font-size: 11px; font-family: ui-monospace, monospace; }

      .erd-rel {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0 8px;
        min-height: 120px;
        position: relative;
      }
      .erd-rel-line {
        width: 100%; min-width: 40px; height: 2px;
        background: rgba(148,163,184,.35);
        position: relative;
        margin-top: 30px;
      }
      .erd-rel-line::before {
        content: '1'; position: absolute; left: -2px; top: -18px;
        font-size: 11px; font-weight: 700; color: #94a3b8;
      }
      .erd-rel-line::after {
        content: 'N'; position: absolute; right: -2px; top: -18px;
        font-size: 11px; font-weight: 700; color: #94a3b8;
      }
      .erd-rel-label {
        font-size: 10px; color: #64748b; margin-top: 6px;
        text-align: center; white-space: nowrap;
      }

      .erd-indexes {
        margin-top: 8px; padding: 8px 14px;
        border-top: 1px solid rgba(148,163,184,.15);
        font-size: 11px; color: #64748b;
      }
      .erd-indexes code {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #94a3b8;
      }

      /* ── Controls ────────────────────────────────── */
      .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }

      .filter-tabs { display: flex; flex-wrap: wrap; gap: 6px; flex: 1; }
      .tab {
        padding: 6px 14px; border-radius: 999px;
        border: 1px solid rgba(148,163,184,.3);
        background: transparent; color: #94a3b8;
        font-size: 12px; font-weight: 700; cursor: pointer;
        transition: border-color .15s, color .15s, background .15s;
        white-space: nowrap;
      }
      .tab:hover { border-color: rgba(248,250,252,.5); color: #f8fafc; }
      .tab.active {
        border-color: rgba(248,250,252,.7); color: #f8fafc;
        background: rgba(248,250,252,.08);
      }

      .search-wrap { position: relative; }
      .search-wrap svg {
        position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
        color: #64748b; pointer-events: none;
      }
      #search {
        padding: 7px 10px 7px 32px; border-radius: 8px;
        border: 1px solid rgba(148,163,184,.3);
        background: rgba(15,23,42,.65); color: #f8fafc;
        font-size: 13px; width: 220px; outline: none;
      }
      #search:focus { border-color: rgba(148,163,184,.7); }
      #search::placeholder { color: #475569; }

      .count-label { font-size: 12px; color: #475569; white-space: nowrap; }

      /* ── Query Index ────────────────────────────── */
      .qi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 6px;
      }
      .qi-item {
        display: flex; align-items: center; gap: 8px;
        padding: 7px 12px; border-radius: 8px;
        background: rgba(15,23,42,.45);
        border: 1px solid rgba(148,163,184,.1);
        text-decoration: none;
        transition: border-color .15s, background .15s;
        cursor: pointer;
      }
      .qi-item:hover {
        border-color: rgba(148,163,184,.35);
        background: rgba(15,23,42,.7);
      }
      .qi-id {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #38bdf8; white-space: nowrap; flex-shrink: 0;
        min-width: 48px;
      }
      .qi-title {
        font-size: 12px; color: #dbe2ec; line-height: 1.35;
        flex: 1;
      }
      .qi-op {
        font-size: 9px; font-weight: 800; letter-spacing: .04em;
        padding: 1px 5px; border-radius: 4px; white-space: nowrap; flex-shrink: 0;
      }

      /* ── Badges ──────────────────────────────────── */
      .badge {
        display: inline-block; padding: 2px 7px;
        border-radius: 5px; font-size: 11px; font-weight: 700;
        white-space: nowrap; letter-spacing: .02em;
      }
      .badge-ddl  { background: rgba(56,189,248,.15);  color: #38bdf8; }
      .badge-dml  { background: rgba(245,208,106,.15); color: #f5d06a; }
      .badge-dql  { background: rgba(62,224,169,.15);  color: #3ee0a9; }

      .op-badge {
        display: inline-block; padding: 2px 7px;
        border-radius: 5px; font-size: 10px; font-weight: 800;
        letter-spacing: .04em; white-space: nowrap;
      }
      .op-select   { background: rgba(62,224,169,.12);  color: #3ee0a9; }
      .op-insert   { background: rgba(56,189,248,.12);  color: #38bdf8; }
      .op-delete   { background: rgba(248,113,113,.12); color: #f87171; }
      .op-create   { background: rgba(245,208,106,.12); color: #f5d06a; }
      .op-truncate { background: rgba(148,163,184,.12); color: #94a3b8; }

      /* ── Query cards ────────────────────────────── */
      .query-list { display: flex; flex-direction: column; gap: 12px; }

      .query-card {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        background: rgba(11,13,19,.5);
        overflow: hidden;
        transition: border-color .15s;
        scroll-margin-top: 16px;
      }
      .query-card:hover { border-color: rgba(255,255,255,.16); }
      .query-card.highlight { border-color: rgba(56,189,248,.5); }

      .query-header {
        display: flex; align-items: center; gap: 10px;
        padding: 14px 16px;
        cursor: pointer;
        user-select: none;
      }
      .query-header:hover { background: rgba(255,255,255,.03); }

      .query-chevron {
        color: #475569; transition: transform .2s;
        flex-shrink: 0; font-size: 10px;
      }
      .query-card.open .query-chevron { transform: rotate(90deg); }

      .query-id {
        font-family: ui-monospace, monospace; font-size: 12px;
        color: #38bdf8; white-space: nowrap; flex-shrink: 0;
      }

      .query-title {
        flex: 1; color: #f1f5f9; font-size: 13px; font-weight: 600;
        line-height: 1.4;
      }

      .query-meta {
        display: flex; gap: 6px; align-items: center; flex-shrink: 0;
      }

      .query-body {
        display: none;
        padding: 0 16px 18px 16px;
      }
      .query-card.open .query-body { display: block; }

      .query-desc {
        color: #94a3b8; font-size: 13px; line-height: 1.55;
        margin-bottom: 14px;
      }

      /* ── SQL code block ─────────────────────────── */
      .sql-block {
        position: relative;
        font-family: ui-monospace, "Cascadia Code", "Fira Code", Menlo, monospace;
        font-size: 13px; line-height: 1.6;
        padding: 16px 18px;
        border-radius: 10px;
        background: rgba(15,23,42,.7);
        border: 1px solid rgba(148,163,184,.12);
        overflow-x: auto;
        white-space: pre;
        color: #e2e8f0;
        margin-bottom: 14px;
        tab-size: 2;
      }
      .sql-block .kw    { color: #38bdf8; font-weight: 700; }
      .sql-block .fn    { color: #a78bfa; }
      .sql-block .str   { color: #f5d06a; }
      .sql-block .param { color: #f87171; font-weight: 700; }
      .sql-block .cmt   { color: #475569; font-style: italic; }
      .sql-block .type  { color: #3ee0a9; }
      .sql-block .tbl   { color: #fbbf24; }

      .copy-btn {
        position: absolute; top: 8px; right: 8px;
        padding: 4px 10px; border-radius: 6px;
        border: 1px solid rgba(148,163,184,.25);
        background: rgba(15,23,42,.8); color: #94a3b8;
        font-size: 11px; font-weight: 600; cursor: pointer;
        transition: color .15s, border-color .15s;
      }
      .copy-btn:hover { color: #f8fafc; border-color: rgba(148,163,184,.6); }

      /* ── Detail fields ──────────────────────────── */
      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .detail-grid .full { grid-column: 1 / -1; }

      .detail-field { display: flex; flex-direction: column; gap: 5px; }
      .detail-label {
        font-size: 10px; font-weight: 700; text-transform: uppercase;
        letter-spacing: .08em; color: #64748b;
      }
      .detail-value {
        color: #dbe2ec; line-height: 1.5; font-size: 13px;
        padding: 8px 10px; border-radius: 8px;
        background: rgba(15,23,42,.55);
        border: 1px solid rgba(148,163,184,.12);
      }
      .detail-value code {
        font-family: ui-monospace, monospace;
        font-size: 12px; color: #a78bfa;
        background: rgba(167,139,250,.1);
        padding: 1px 4px; border-radius: 3px;
      }

      .param-table {
        width: 100%; border-collapse: collapse;
        font-size: 13px;
      }
      .param-table th {
        text-align: left; padding: 6px 10px;
        font-size: 10px; font-weight: 700; text-transform: uppercase;
        letter-spacing: .06em; color: #64748b;
        border-bottom: 1px solid rgba(255,255,255,.08);
      }
      .param-table td {
        padding: 6px 10px;
        border-bottom: 1px solid rgba(255,255,255,.04);
        color: #dbe2ec;
      }
      .param-table tr:last-child td { border-bottom: none; }
      .param-idx {
        font-family: ui-monospace, monospace; font-size: 12px;
        font-weight: 700; color: #f87171;
      }
      .param-name {
        font-family: ui-monospace, monospace; font-size: 12px;
        color: #f1f5f9;
      }
      .param-type {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #3ee0a9;
      }

      /* ── Explain block ──────────────────────────── */
      .explain-block {
        font-family: ui-monospace, monospace;
        font-size: 12px; line-height: 1.55;
        padding: 12px 14px;
        border-radius: 8px;
        background: rgba(15,23,42,.65);
        border: 1px solid rgba(148,163,184,.1);
        color: #94a3b8;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .explain-block .ex-node { color: #38bdf8; }
      .explain-block .ex-cost { color: #f5d06a; }
      .explain-block .ex-note { color: #3ee0a9; }

      /* ── Error handling block ───────────────────── */
      .error-list {
        margin: 0; padding: 0; list-style: none;
        display: flex; flex-direction: column; gap: 8px;
      }
      .error-item {
        display: flex; gap: 10px; align-items: flex-start;
        padding: 8px 10px; border-radius: 8px;
        background: rgba(15,23,42,.4);
        border: 1px solid rgba(148,163,184,.08);
      }
      .error-code {
        font-family: ui-monospace, monospace; font-size: 11px;
        font-weight: 700; white-space: nowrap; flex-shrink: 0;
        padding: 2px 6px; border-radius: 4px;
        min-width: 40px; text-align: center;
      }
      .error-code-pg { background: rgba(248,113,113,.12); color: #f87171; }
      .error-code-http { background: rgba(245,208,106,.12); color: #f5d06a; }
      .error-code-app { background: rgba(167,139,250,.12); color: #a78bfa; }
      .error-text { font-size: 13px; color: #dbe2ec; line-height: 1.45; }

      /* ── Info grid ──────────────────────────────── */
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .info-item {
        padding: 10px 14px; border-radius: 10px;
        background: rgba(15,23,42,.55);
        border: 1px solid rgba(148,163,184,.12);
      }
      .info-item dt {
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        letter-spacing: .06em; color: #38bdf8; margin-bottom: 4px;
      }
      .info-item dd {
        margin: 0; color: #dbe2ec; font-size: 13px; line-height: 1.5;
      }

      /* ── Responsive ─────────────────────────────── */
      @media (max-width: 640px) {
        .erd-wrap { grid-template-columns: 1fr; gap: 10px; }
        .erd-rel { flex-direction: row; min-height: auto; padding: 4px 0; }
        .erd-rel-line { width: 2px; height: 30px; min-width: 2px; margin-top: 0; }
        .info-grid { grid-template-columns: 1fr; }
        .detail-grid { grid-template-columns: 1fr; }
        #search { width: 100%; }
        .controls { flex-direction: column; align-items: stretch; }
        .query-meta { display: none; }
        .qi-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">

      <!-- Back link -->
      <a class="back" href="/">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Back to CV
      </a>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- HEADER                                                               -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h1>SQL Reference</h1>
        <p class="subtitle">SlotsOne — PostgreSQL 16 Database Layer &nbsp;|&nbsp; v1.0 &nbsp;|&nbsp; Last updated: 2026-02-28</p>

        <p>Complete reference of every SQL statement executed by the SlotsOne backend.
           All queries use parameterised placeholders (<code style="color:#f87171">$1, $2, &hellip;</code>) via the
           <code>pg</code> driver to prevent SQL injection. No raw string concatenation is ever used.</p>

        <div class="stats" id="stats"></div>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- SCHEMA ERD                                                           -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Database Schema (ERD)</h2>
        <p>Six tables across two migrations (<code>001_init.sql</code>, <code>002_game_history.sql</code>), executed on every server startup via <code>initDb()</code>.
           All DDL uses <code>IF NOT EXISTS</code> for idempotency.</p>

        <div class="erd-wrap">
          <!-- users table -->
          <div class="erd-table erd-tbl-users">
            <div class="erd-table-head">
              <span class="tbl-icon">U</span>
              users
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td><span class="erd-def">gen_random_uuid()</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">email</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-uq">UNIQUE</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">password_hash</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
          </div>

          <!-- relationship -->
          <div class="erd-rel">
            <div class="erd-rel-line"></div>
            <div class="erd-rel-label">ON DELETE CASCADE</div>
          </div>

          <!-- refresh_tokens table -->
          <div class="erd-table erd-tbl-tokens">
            <div class="erd-table-head">
              <span class="tbl-icon">T</span>
              refresh_tokens
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">token</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">user_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">&rarr; users(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">expires_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
            <div class="erd-indexes">
              <code>idx_refresh_tokens_user_id</code> B-tree on <code>user_id</code><br>
              <code>idx_refresh_tokens_expires_at</code> B-tree on <code>expires_at</code>
            </div>
          </div>
        </div>

        <!-- wallets ↔ seed_pairs -->
        <div class="erd-wrap">
          <div class="erd-table erd-tbl-wallets">
            <div class="erd-table-head">
              <span class="tbl-icon">W</span>
              wallets
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td><span class="erd-def">gen_random_uuid()</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">user_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span> <span class="erd-col-constraint erd-uq">UNIQUE</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">&rarr; users(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">balance_cents</span></td>
                <td><span class="erd-col-type">BIGINT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">100000</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">version</span></td>
                <td><span class="erd-col-type">INTEGER</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">1</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">updated_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
          </div>

          <div class="erd-rel">
            <div class="erd-rel-line"></div>
            <div class="erd-rel-label">ON DELETE CASCADE</div>
          </div>

          <div class="erd-table erd-tbl-seeds">
            <div class="erd-table-head">
              <span class="tbl-icon">S</span>
              seed_pairs
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td><span class="erd-def">gen_random_uuid()</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">user_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">&rarr; users(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">server_seed</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">server_seed_hash</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">client_seed</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">'default'</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">nonce</span></td>
                <td><span class="erd-col-type">INTEGER</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">0</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">active</span></td>
                <td><span class="erd-col-type">BOOLEAN</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">TRUE</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">revealed_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
            <div class="erd-indexes">
              <code>idx_seed_pairs_user_active</code> B-tree on <code>(user_id, active)</code>
            </div>
          </div>
        </div>

        <!-- game_rounds ↔ transactions -->
        <div class="erd-wrap">
          <div class="erd-table erd-tbl-rounds">
            <div class="erd-table-head">
              <span class="tbl-icon">R</span>
              game_rounds
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td><span class="erd-def">gen_random_uuid()</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">user_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">&rarr; users(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">session_id</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">game_id</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">seed_pair_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span></td>
                <td><span class="erd-def">&rarr; seed_pairs(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">nonce</span></td>
                <td><span class="erd-col-type">INTEGER</span></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">bet_cents</span></td>
                <td><span class="erd-col-type">BIGINT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">win_cents</span></td>
                <td><span class="erd-col-type">BIGINT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">0</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">currency</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">'USD'</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">lines</span></td>
                <td><span class="erd-col-type">INTEGER</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">balance_before_cents</span></td>
                <td><span class="erd-col-type">BIGINT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">balance_after_cents</span></td>
                <td><span class="erd-col-type">BIGINT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">reel_matrix</span></td>
                <td><span class="erd-col-type">JSONB</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">win_breakdown</span></td>
                <td><span class="erd-col-type">JSONB</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">'[]'::jsonb</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">bonus_triggered</span></td>
                <td><span class="erd-col-type">JSONB</span></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">outcome_hash</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
            <div class="erd-indexes">
              <code>idx_game_rounds_user_created</code> B-tree on <code>(user_id, created_at DESC)</code>
            </div>
          </div>

          <div class="erd-rel">
            <div class="erd-rel-line"></div>
            <div class="erd-rel-label">ON DELETE CASCADE</div>
          </div>

          <div class="erd-table erd-tbl-txns">
            <div class="erd-table-head">
              <span class="tbl-icon">X</span>
              transactions
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td><span class="erd-def">gen_random_uuid()</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">round_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">&rarr; game_rounds(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">user_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">&rarr; users(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">type</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">CHECK ('bet','win')</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">amount_cents</span></td>
                <td><span class="erd-col-type">BIGINT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">balance_after_cents</span></td>
                <td><span class="erd-col-type">BIGINT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
            <div class="erd-indexes">
              <code>idx_transactions_user_created</code> B-tree on <code>(user_id, created_at DESC)</code>
            </div>
          </div>
        </div>

        <h3>Connection Pool</h3>
        <dl class="info-grid">
          <div class="info-item"><dt>Driver</dt><dd><code>pg.Pool</code> (node-postgres) &mdash; singleton, lazily initialised</dd></div>
          <div class="info-item"><dt>Max Connections</dt><dd>10 concurrent connections</dd></div>
          <div class="info-item"><dt>Idle Timeout</dt><dd>30 000 ms (30 s)</dd></div>
          <div class="info-item"><dt>Connect Timeout</dt><dd>5 000 ms (5 s)</dd></div>
        </dl>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- QUERY INDEX                                                          -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Query Index</h2>
        <p style="margin-bottom:12px">Click any row to jump to the full query detail.</p>
        <div class="qi-grid" id="qi-grid">
          <!-- filled by JS -->
        </div>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- CONTROLS                                                             -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <div class="controls">
          <div class="filter-tabs" id="filters">
            <button class="tab active" data-filter="all">All</button>
            <button class="tab" data-filter="ddl">DDL</button>
            <button class="tab" data-filter="dml">DML</button>
            <button class="tab" data-filter="dql">DQL</button>
          </div>
          <div class="search-wrap">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="search" placeholder="Search queries..." />
          </div>
          <span class="count-label" id="count-label"></span>
        </div>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- QUERY LIST                                                           -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="query-list" id="query-list">
        <!-- filled by JS -->
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- SECURITY & BEST PRACTICES                                            -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Security &amp; Best Practices</h2>
        <dl class="info-grid">
          <div class="info-item">
            <dt>Parameterised Queries</dt>
            <dd>Every user-supplied value is passed as a <code>$N</code> placeholder argument &mdash; never concatenated into SQL strings. This eliminates SQL injection vectors.</dd>
          </div>
          <div class="info-item">
            <dt>Atomic Token Rotation</dt>
            <dd><code>DELETE &hellip; RETURNING</code> consumes a refresh token and retrieves the owner in a single atomic statement, preventing race conditions and replay attacks.</dd>
          </div>
          <div class="info-item">
            <dt>Cascade Deletion</dt>
            <dd>The <code>refresh_tokens.user_id</code> FK uses <code>ON DELETE CASCADE</code> &mdash; deleting a user automatically purges all their tokens.</dd>
          </div>
          <div class="info-item">
            <dt>Unique Constraints</dt>
            <dd>The <code>users.email</code> column has a <code>UNIQUE</code> constraint. The app catches PostgreSQL error code <code>23505</code> and returns a 409 Conflict.</dd>
          </div>
          <div class="info-item">
            <dt>Server-Side TTL</dt>
            <dd>Token expiration is computed by the database: <code>NOW() + interval '7 days'</code>, avoiding clock-skew between Node.js and PostgreSQL.</dd>
          </div>
          <div class="info-item">
            <dt>Idempotent Migrations</dt>
            <dd>All DDL uses <code>CREATE TABLE IF NOT EXISTS</code> and <code>CREATE INDEX IF NOT EXISTS</code> &mdash; safe to run repeatedly on every server start.</dd>
          </div>
          <div class="info-item">
            <dt>Index Coverage</dt>
            <dd>B-tree indexes on <code>refresh_tokens(user_id)</code> and <code>refresh_tokens(expires_at)</code> ensure O(log&nbsp;n) lookups for validation and cleanup.</dd>
          </div>
          <div class="info-item">
            <dt>Graceful Shutdown</dt>
            <dd><code>closePool()</code> drains active connections and resets the singleton reference, preventing connection leaks on restart.</dd>
          </div>
          <div class="info-item">
            <dt>Optimistic Locking</dt>
            <dd>Wallet debits use a <code>version</code> column check in the WHERE clause. If a concurrent request modifies the wallet between read and update, the version mismatch causes 0 rows affected &mdash; preventing lost updates without SELECT FOR UPDATE locks.</dd>
          </div>
          <div class="info-item">
            <dt>BIGINT Cents</dt>
            <dd>All monetary values are stored as <code>BIGINT</code> in cents (1 USD = 100 cents). This eliminates IEEE 754 floating-point rounding errors that occur with <code>DECIMAL</code> or <code>FLOAT</code> in JavaScript.</dd>
          </div>
          <div class="info-item">
            <dt>Transactional Round Creation</dt>
            <dd>Game round + transaction inserts are wrapped in <code>BEGIN/COMMIT</code> using <code>pool.connect()</code>. On failure, <code>ROLLBACK</code> ensures no orphaned records persist.</dd>
          </div>
          <div class="info-item">
            <dt>HMAC-SHA256 Seeds</dt>
            <dd>Provably fair seeds use <code>HMAC-SHA256(server_seed, client_seed:nonce)</code> for spin derivation and <code>SHA-256</code> for server seed hashing. The server seed is never exposed while the pair is active.</dd>
          </div>
          <div class="info-item">
            <dt>Composite Indexes</dt>
            <dd>Composite B-tree indexes on <code>(user_id, created_at DESC)</code> and <code>(user_id, active)</code> eliminate sort steps and heap filters for the most frequent query patterns.</dd>
          </div>
        </dl>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- SOURCE FILES                                                         -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Source Files</h2>
        <dl class="info-grid">
          <div class="info-item"><dt>Migration (Auth)</dt><dd><code>backend/src/migrations/001_init.sql</code></dd></div>
          <div class="info-item"><dt>Migration (Game)</dt><dd><code>backend/src/migrations/002_game_history.sql</code></dd></div>
          <div class="info-item"><dt>Connection Pool</dt><dd><code>backend/src/db.ts</code></dd></div>
          <div class="info-item"><dt>User Store</dt><dd><code>backend/src/userStore.ts</code></dd></div>
          <div class="info-item"><dt>Token Store</dt><dd><code>backend/src/auth/refreshTokenStore.ts</code></dd></div>
          <div class="info-item"><dt>Wallet Store</dt><dd><code>backend/src/walletStore.ts</code></dd></div>
          <div class="info-item"><dt>Seed Store</dt><dd><code>backend/src/seedStore.ts</code></dd></div>
          <div class="info-item"><dt>Round Store</dt><dd><code>backend/src/roundStore.ts</code></dd></div>
          <div class="info-item"><dt>Provably Fair</dt><dd><code>backend/src/provablyFair.ts</code></dd></div>
        </dl>
      </div>

    </div>

    <script>
    /* ======================================================================= */
    /*  QUERY DATA                                                             */
    /* ======================================================================= */
    const QUERIES = [
      // ── DDL ─────────────────────────────────────────────────────────────────
      {
        id: 'DDL-01', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create users table',
        desc: 'Creates the users table with a UUID primary key (auto-generated via gen_random_uuid()), a unique email column, a scrypt password hash, and a creation timestamp. IF NOT EXISTS makes the statement idempotent.',
        sql: 'CREATE TABLE IF NOT EXISTS users (\n  id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n  email         TEXT        UNIQUE NOT NULL,\n  password_hash TEXT        NOT NULL,\n  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan. Internally PostgreSQL:\n1. Acquires AccessExclusiveLock on pg_class\n2. Checks pg_class for existing relation named "users"\n3. If absent: creates heap file, adds pg_attribute entries,\n   creates btree index for PK, creates unique index for email\n4. If present: returns silently (IF NOT EXISTS)',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS \u2014 statement becomes a no-op instead of raising an error.' },
          { code: '42501', type: 'pg', label: 'insufficient_privilege', text: 'The DATABASE_URL role must have CREATE privilege on the target schema. Fails at startup if missing.' },
        ],
      },
      {
        id: 'DDL-02', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create refresh_tokens table',
        desc: 'Creates the refresh_tokens table with a text primary key (the token itself), a foreign key to users.id with ON DELETE CASCADE, an expiration timestamp, and a creation timestamp.',
        sql: 'CREATE TABLE IF NOT EXISTS refresh_tokens (\n  token      TEXT        PRIMARY KEY,\n  user_id    UUID        NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  expires_at TIMESTAMPTZ NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan.\n1. Creates heap + PK btree index on token column\n2. Adds FK constraint referencing users(id)\n3. Registers ON DELETE CASCADE trigger on users\n4. Must run AFTER DDL-01 (users table must exist)',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
          { code: '42830', type: 'pg', label: 'invalid_foreign_key', text: 'Raised if users table does not exist. Prevented by migration order (users created first).' },
        ],
      },
      {
        id: 'DDL-03', category: 'ddl', op: 'CREATE INDEX',
        title: 'Index on refresh_tokens(user_id)',
        desc: 'B-tree index for fast lookups when revoking all tokens for a specific user (logout-all-devices). Also benefits the CASCADE delete path.',
        sql: 'CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id\n  ON refresh_tokens(user_id);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Index created or no-op if exists',
        explain: 'Creates a B-tree index on the user_id column.\nUsed by: DML-04 (DELETE WHERE user_id = $1)\nWithout this index \u2192 Seq Scan on refresh_tokens\nWith this index    \u2192 Index Scan using idx_refresh_tokens_user_id\nComplexity: O(log n) lookups vs O(n) full scan',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-04', category: 'ddl', op: 'CREATE INDEX',
        title: 'Index on refresh_tokens(expires_at)',
        desc: 'B-tree index enabling efficient range scans for expired token cleanup. Supports future batch deletion queries.',
        sql: 'CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires_at\n  ON refresh_tokens(expires_at);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Index created or no-op if exists',
        explain: 'Creates a B-tree index on the expires_at column.\nEnables: DELETE FROM refresh_tokens WHERE expires_at < NOW()\nPlan: Index Scan using idx_refresh_tokens_expires_at\n  \u2192 Filter: (expires_at < now())\nUseful for scheduled cleanup of expired tokens at scale.',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-05', category: 'ddl', op: 'BATCH',
        title: 'Execute full migration script (initDb)',
        desc: 'Reads 001_init.sql from disk and executes all four DDL statements (DDL-01 through DDL-04) as a single query batch in one database round-trip. Called once on server startup.',
        sql: '-- File: 001_init.sql (executed as single batch)\n-- 1. CREATE TABLE IF NOT EXISTS users (...)\n-- 2. CREATE TABLE IF NOT EXISTS refresh_tokens (...)\n-- 3. CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id ...\n-- 4. CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires_at ...',
        params: [],
        source: 'backend/src/db.ts \u2192 initDb()',
        returns: 'No result rows',
        explain: 'Sends multi-statement SQL via pool.query(sql).\nPostgreSQL processes each statement sequentially\nwithin a single implicit transaction.\nAll IF NOT EXISTS guards make this safe for\nrepeated execution on every server restart.',
        errors: [
          { code: 'ECONNREFUSED', type: 'app', label: 'connection_refused', text: 'PostgreSQL is not running or DATABASE_URL is wrong. Server startup fails with an unhandled rejection.' },
          { code: '28P01', type: 'pg', label: 'invalid_password', text: 'DATABASE_URL credentials are incorrect. Connection is rejected before any DDL runs.' },
          { code: '3D000', type: 'pg', label: 'invalid_catalog_name', text: 'Database name in DATABASE_URL does not exist. Must be created first (docker-compose handles this).' },
        ],
      },

      // ── DML: INSERT ─────────────────────────────────────────────────────────
      {
        id: 'DML-01', category: 'dml', op: 'INSERT',
        title: 'Insert new user (registration)',
        desc: 'Inserts a new user with a lowercased email and scrypt password hash. RETURNING eliminates a second SELECT round-trip. On duplicate email, PostgreSQL raises 23505 which the app catches and maps to HTTP 409.',
        sql: 'INSERT INTO users (email, password_hash)\nVALUES ($1, $2)\nRETURNING id, email, password_hash;',
        params: [
          { idx: '$1', name: 'email', type: 'TEXT', desc: 'User email, lowercased via email.toLowerCase() before query' },
          { idx: '$2', name: 'passwordHash', type: 'TEXT', desc: 'Scrypt hash string in salt:derivedKey hex format' },
        ],
        source: 'backend/src/userStore.ts \u2192 createUser()',
        returns: '{ id: UUID, email: TEXT, password_hash: TEXT }',
        explain: 'Insert on Conflict: uses unique index on email column\n\nPlan: Insert on users\n  \u2192 Result (generates row with gen_random_uuid())\n  \u2192 Constraint check: users_email_key (UNIQUE)\n  \u2192 If passes: insert heap tuple, update PK + UNIQUE indexes\n  \u2192 If violates: raise 23505 unique_violation\n\nCost: single index probe on email + heap insert\nReturning: avoids separate SELECT by returning in same statement',
        errors: [
          { code: '23505', type: 'pg', label: 'unique_violation', text: 'Email already exists. Caught in createUser() catch block \u2192 throws Error("email_taken") \u2192 route returns <strong>HTTP 409</strong> { error: "Email already registered", code: "email_taken" }' },
          { code: '23502', type: 'pg', label: 'not_null_violation', text: 'Would fire if $1 or $2 is null. Prevented by Zod schema validation in the auth route before the query runs.' },
          { code: 'ECONNREFUSED', type: 'app', label: 'pool_error', text: 'Pool cannot connect. Bubbles up as 500 to the global error handler.' },
        ],
      },
      {
        id: 'DML-02', category: 'dml', op: 'INSERT',
        title: 'Insert refresh token',
        desc: 'Stores a new refresh token with a 7-day TTL computed server-side by PostgreSQL. The token is a crypto-random 32-byte hex string from Node.js crypto.randomBytes().',
        sql: "INSERT INTO refresh_tokens (token, user_id, expires_at)\nVALUES ($1, $2, NOW() + interval '7 days');",
        params: [
          { idx: '$1', name: 'token', type: 'TEXT', desc: '64-char hex string from crypto.randomBytes(32).toString("hex")' },
          { idx: '$2', name: 'userId', type: 'UUID', desc: 'User UUID from users.id (returned by DML-01 or DQL-01)' },
        ],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 createRefreshToken()',
        returns: 'No result rows (INSERT without RETURNING)',
        explain: "Plan: Insert on refresh_tokens\n  \u2192 Result (evaluates NOW() + interval '7 days')\n  \u2192 Constraint check: refresh_tokens_pkey (PK on token)\n  \u2192 FK check: users_pkey (verifies user_id exists)\n  \u2192 Insert heap tuple, update PK + user_id + expires_at indexes\n\nServer-side NOW() avoids clock-skew between Node.js and PostgreSQL.\nThe 64-char hex token has 2\u00b9\u2076\u2078 possible values \u2192 collision probability \u2248 0.",
        errors: [
          { code: '23505', type: 'pg', label: 'unique_violation', text: 'Token collision (astronomically unlikely with 256-bit random). Would cause a 500 error. In practice, never occurs.' },
          { code: '23503', type: 'pg', label: 'foreign_key_violation', text: 'user_id does not exist in users table. Prevented by the auth flow: user must exist before tokens are created.' },
        ],
      },

      // ── DML: DELETE ─────────────────────────────────────────────────────────
      {
        id: 'DML-03', category: 'dml', op: 'DELETE',
        title: 'Consume refresh token (atomic rotation)',
        desc: 'Atomically deletes a refresh token and returns its owner in one statement. The token is destroyed on use, preventing replay attacks. Application checks expires_at after deletion \u2014 even expired tokens are always deleted.',
        sql: 'DELETE FROM refresh_tokens\nWHERE token = $1\nRETURNING user_id, expires_at;',
        params: [
          { idx: '$1', name: 'token', type: 'TEXT', desc: 'Refresh token string extracted from the httpOnly cookie' },
        ],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 consumeRefreshToken()',
        returns: '{ user_id: UUID, expires_at: TIMESTAMPTZ } or empty rowset',
        explain: 'Plan: Delete on refresh_tokens\n  \u2192 Index Scan using refresh_tokens_pkey\n        Index Cond: (token = $1)\n  \u2192 Delete heap tuple + remove from all 3 indexes\n  \u2192 Return deleted row data via RETURNING\n\nCost: O(1) \u2014 PK lookup is a single btree probe.\nAtomicity: DELETE + RETURNING is a single statement,\nso concurrent requests cannot both consume the same token.\nEven if the token is expired, it is deleted to prevent reuse.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'Token not found (invalid or already consumed). Function returns <code>null</code> \u2192 route returns <strong>HTTP 401</strong> { error: "Invalid or expired refresh token", code: "invalid_refresh_token" }' },
          { code: '\u2014', type: 'app', label: 'expires_at < now', text: 'Token found but expired. Row is still deleted (preventing reuse), but function returns <code>null</code> \u2192 same 401 response.' },
        ],
      },
      {
        id: 'DML-04', category: 'dml', op: 'DELETE',
        title: 'Revoke all tokens for user (logout)',
        desc: 'Deletes every refresh token for a given user, effectively logging them out of all devices. Uses the idx_refresh_tokens_user_id index for efficient lookup.',
        sql: 'DELETE FROM refresh_tokens\nWHERE user_id = $1;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID whose sessions should be terminated' },
        ],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 revokeAllRefreshTokensForUser()',
        returns: 'No result rows consumed',
        explain: 'Plan: Delete on refresh_tokens\n  \u2192 Index Scan using idx_refresh_tokens_user_id\n        Index Cond: (user_id = $1)\n  \u2192 Delete matching heap tuples + update indexes\n\nCost: O(log n + k) where k = number of tokens for this user.\nTypically k = 1\u20133 (one per device).\nWithout the index: Seq Scan \u2192 O(n) full table scan.',
        errors: [
          { code: '\u2014', type: 'app', label: 'no rows deleted', text: 'If the user has no tokens, DELETE succeeds with 0 rows affected. This is not an error \u2014 the function returns void.' },
        ],
      },

      // ── DML: TRUNCATE ───────────────────────────────────────────────────────
      {
        id: 'DML-05', category: 'dml', op: 'TRUNCATE',
        title: 'Truncate users table (test cleanup)',
        desc: 'Removes all rows from users. CASCADE propagates to refresh_tokens via the FK, so both tables are emptied in one statement. Used exclusively in test teardown.',
        sql: 'TRUNCATE TABLE users CASCADE;',
        params: [],
        source: 'backend/src/userStore.ts \u2192 resetUserStoreForTests()',
        returns: 'No result rows',
        explain: 'TRUNCATE vs DELETE:\n  DELETE  \u2192 row-by-row, fires triggers, generates WAL per row\n  TRUNCATE \u2192 deallocates pages, resets sequence, minimal WAL\n\nCASCADE: PostgreSQL follows FK dependency graph\n  and truncates refresh_tokens automatically.\n\nSpeed: O(1) regardless of row count (no scanning).\nCaveat: acquires AccessExclusiveLock on both tables.',
        errors: [
          { code: '0A000', type: 'pg', label: 'feature_not_supported', text: 'Cannot TRUNCATE a table referenced by an FK without CASCADE. Here CASCADE is always specified, so this never fires.' },
        ],
      },
      {
        id: 'DML-06', category: 'dml', op: 'TRUNCATE',
        title: 'Truncate refresh_tokens table (test cleanup)',
        desc: 'Removes all rows from refresh_tokens independently of users. Allows tests to clear tokens while keeping user accounts intact.',
        sql: 'TRUNCATE TABLE refresh_tokens;',
        params: [],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 resetRefreshTokenStoreForTests()',
        returns: 'No result rows',
        explain: 'Same O(1) performance as DML-05.\nNo CASCADE needed because refresh_tokens\nhas no dependent foreign keys pointing to it.\nAcquires AccessExclusiveLock on refresh_tokens only.',
        errors: [],
      },

      // ── DQL: SELECT ─────────────────────────────────────────────────────────
      {
        id: 'DQL-01', category: 'dql', op: 'SELECT',
        title: 'Find user by email (login)',
        desc: 'Retrieves a single user row by email for credential verification. The email is lowercased before the query for case-insensitive matching. Returns the password hash for scrypt comparison.',
        sql: 'SELECT id, email, password_hash\nFROM users\nWHERE email = $1;',
        params: [
          { idx: '$1', name: 'email', type: 'TEXT', desc: 'User email, lowercased via email.toLowerCase() before query' },
        ],
        source: 'backend/src/userStore.ts \u2192 findUserByEmail()',
        returns: '{ id: UUID, email: TEXT, password_hash: TEXT } or empty rowset',
        explain: 'Plan: Index Scan using users_email_key\n  Index Cond: (email = $1)\n  \u2192 Fetches single heap tuple via UNIQUE index\n\nCost: O(1) \u2014 single btree probe on the UNIQUE index.\nThe UNIQUE constraint guarantees at most 1 row returned.\nNo Seq Scan possible because the planner always\nchooses the unique index for equality predicates.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'User not found. Function returns <code>undefined</code> \u2192 route returns <strong>HTTP 401</strong> { error: "Invalid credentials", code: "invalid_credentials" }. Error intentionally does not reveal whether email or password was wrong.' },
        ],
      },

      // ── DDL: Game History (002_game_history.sql) ──────────────────────────
      {
        id: 'DDL-06', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create wallets table (BIGINT cents, optimistic locking)',
        desc: 'Creates the wallets table storing user balances as BIGINT cents to avoid floating-point precision issues. Includes a version column for optimistic concurrency control on debits. Default balance is 100000 (= 1000.00 USD).',
        sql: 'CREATE TABLE IF NOT EXISTS wallets (\n  id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id       UUID        UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  balance_cents BIGINT      NOT NULL DEFAULT 100000,\n  version       INTEGER     NOT NULL DEFAULT 1,\n  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);',
        params: [],
        source: 'backend/src/migrations/002_game_history.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan.\n1. Creates heap file + PK btree on id\n2. Creates UNIQUE index on user_id\n3. Registers FK constraint \u2192 users(id) with CASCADE\n4. BIGINT stores money as integer cents \u2014\n   avoids IEEE 754 rounding errors',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
          { code: '42830', type: 'pg', label: 'invalid_foreign_key', text: 'users table must exist. Guaranteed by migration order.' },
        ],
      },
      {
        id: 'DDL-07', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create seed_pairs table (provably fair)',
        desc: 'Creates the seed_pairs table for provably fair mechanics. Each pair has a server_seed (hidden while active), its SHA-256 hash (visible to user), a client_seed, and a nonce counter. The active flag ensures only one pair is active per user at a time.',
        sql: 'CREATE TABLE IF NOT EXISTS seed_pairs (\n  id               UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id          UUID        NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  server_seed      TEXT        NOT NULL,\n  server_seed_hash TEXT        NOT NULL,\n  client_seed      TEXT        NOT NULL DEFAULT \'default\',\n  nonce            INTEGER     NOT NULL DEFAULT 0,\n  active           BOOLEAN     NOT NULL DEFAULT TRUE,\n  revealed_at      TIMESTAMPTZ,\n  created_at       TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);',
        params: [],
        source: 'backend/src/migrations/002_game_history.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan.\n1. Creates heap + PK btree on id\n2. FK on user_id \u2192 users(id) with CASCADE\n3. BOOLEAN active flag for seed rotation logic\n4. revealed_at is NULL while active (server_seed hidden)',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-08', category: 'ddl', op: 'CREATE INDEX',
        title: 'Composite index on seed_pairs(user_id, active)',
        desc: 'Composite B-tree index optimising the frequent query "find the active seed pair for a user". Both columns in the index eliminate the need for a heap filter.',
        sql: 'CREATE INDEX IF NOT EXISTS idx_seed_pairs_user_active\n  ON seed_pairs(user_id, active);',
        params: [],
        source: 'backend/src/migrations/002_game_history.sql',
        returns: 'Index created or no-op if exists',
        explain: 'Creates a composite B-tree index.\nUsed by: DQL-06 (getActiveSeedPair)\nPlan: Index Scan using idx_seed_pairs_user_active\n  Index Cond: (user_id = $1 AND active = TRUE)\nComplexity: O(log n) \u2014 direct lookup, no filter step',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-09', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create game_rounds table (JSONB reel_matrix/win_breakdown)',
        desc: 'Creates the game_rounds table storing every spin result. Uses JSONB for reel_matrix and win_breakdown to preserve variable-shape game data without schema changes. Links to seed_pairs for provably fair verification.',
        sql: 'CREATE TABLE IF NOT EXISTS game_rounds (\n  id                  UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id             UUID        NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  session_id          TEXT        NOT NULL,\n  game_id             TEXT        NOT NULL,\n  seed_pair_id        UUID        REFERENCES seed_pairs(id),\n  nonce               INTEGER,\n  bet_cents           BIGINT      NOT NULL,\n  win_cents           BIGINT      NOT NULL DEFAULT 0,\n  currency            TEXT        NOT NULL DEFAULT \'USD\',\n  lines               INTEGER     NOT NULL,\n  balance_before_cents BIGINT     NOT NULL,\n  balance_after_cents  BIGINT     NOT NULL,\n  reel_matrix         JSONB       NOT NULL,\n  win_breakdown       JSONB       NOT NULL DEFAULT \'[]\'::jsonb,\n  bonus_triggered     JSONB,\n  outcome_hash        TEXT,\n  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);',
        params: [],
        source: 'backend/src/migrations/002_game_history.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan.\n1. 17 columns including 3 JSONB fields\n2. FK to users(id) with CASCADE\n3. Optional FK to seed_pairs(id) (nullable)\n4. JSONB columns use TOAST for large payloads\n5. outcome_hash enables provably fair verification',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-10', category: 'ddl', op: 'CREATE INDEX',
        title: 'Composite index on game_rounds(user_id, created_at DESC)',
        desc: 'Composite B-tree index with descending created_at for efficient history pagination. Supports ORDER BY created_at DESC with LIMIT/OFFSET without a sort step.',
        sql: 'CREATE INDEX IF NOT EXISTS idx_game_rounds_user_created\n  ON game_rounds(user_id, created_at DESC);',
        params: [],
        source: 'backend/src/migrations/002_game_history.sql',
        returns: 'Index created or no-op if exists',
        explain: 'Creates a composite B-tree with DESC ordering.\nUsed by: DQL-02 (getUserRounds)\nPlan: Index Scan Backward using idx_game_rounds_user_created\n  Index Cond: (user_id = $1)\n  \u2192 No Sort step needed for ORDER BY created_at DESC\nComplexity: O(log n + k) where k = LIMIT',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-11', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create transactions table (CHECK constraint on type)',
        desc: 'Creates the transactions ledger table. Each transaction records a bet debit or win credit. The CHECK constraint ensures type is always \'bet\' or \'win\'. Foreign keys link to game_rounds and users with CASCADE.',
        sql: "CREATE TABLE IF NOT EXISTS transactions (\n  id                  UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n  round_id            UUID        NOT NULL REFERENCES game_rounds(id) ON DELETE CASCADE,\n  user_id             UUID        NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  type                TEXT        NOT NULL CHECK (type IN ('bet', 'win')),\n  amount_cents        BIGINT      NOT NULL,\n  balance_after_cents BIGINT      NOT NULL,\n  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);",
        params: [],
        source: 'backend/src/migrations/002_game_history.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan.\n1. Creates heap + PK btree on id\n2. FK on round_id \u2192 game_rounds(id) with CASCADE\n3. FK on user_id \u2192 users(id) with CASCADE\n4. CHECK constraint enforces type domain\n5. Must be created AFTER game_rounds (FK dependency)',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
          { code: '42830', type: 'pg', label: 'invalid_foreign_key', text: 'game_rounds table must exist first. Guaranteed by SQL ordering in migration file.' },
        ],
      },
      {
        id: 'DDL-12', category: 'ddl', op: 'CREATE INDEX',
        title: 'Composite index on transactions(user_id, created_at DESC)',
        desc: 'Composite B-tree index for efficient transaction history queries per user. Mirrors the game_rounds index pattern for consistent query performance.',
        sql: 'CREATE INDEX IF NOT EXISTS idx_transactions_user_created\n  ON transactions(user_id, created_at DESC);',
        params: [],
        source: 'backend/src/migrations/002_game_history.sql',
        returns: 'Index created or no-op if exists',
        explain: 'Creates a composite B-tree with DESC ordering.\nUsed by: DQL-05 (getRoundTransactions)\nSupports future per-user transaction history queries.\nComplexity: O(log n) lookups',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },

      // ── DML: Wallet Operations ────────────────────────────────────────────
      {
        id: 'DML-07', category: 'dml', op: 'INSERT/UPDATE',
        title: 'Upsert wallet (getOrCreateWallet)',
        desc: 'Creates a wallet for the user if one does not exist, or touches updated_at if it does. Uses INSERT ON CONFLICT (user_id) DO UPDATE as an atomic upsert. Returns the wallet row in either case.',
        sql: 'INSERT INTO wallets (user_id) VALUES ($1)\nON CONFLICT (user_id) DO UPDATE SET updated_at = NOW()\nRETURNING id, user_id, balance_cents, version;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID from JWT sub claim' },
        ],
        source: 'backend/src/walletStore.ts \u2192 getOrCreateWallet()',
        returns: '{ id: UUID, user_id: UUID, balance_cents: BIGINT, version: INTEGER }',
        explain: 'Plan: Insert on Conflict\n  \u2192 Check unique constraint on user_id\n  \u2192 If no conflict: insert new row (balance_cents=100000, version=1)\n  \u2192 If conflict: UPDATE updated_at = NOW()\n  \u2192 RETURNING avoids a second SELECT\n\nCost: O(1) \u2014 single index probe on user_id UNIQUE constraint.\nAtomicity: ON CONFLICT handles the race condition where\ntwo concurrent requests try to create the same wallet.',
        errors: [
          { code: '23503', type: 'pg', label: 'foreign_key_violation', text: 'user_id does not exist in users table. Prevented by auth middleware: JWT must be valid.' },
        ],
      },
      {
        id: 'DML-08', category: 'dml', op: 'UPDATE',
        title: 'Debit wallet with optimistic locking',
        desc: 'Atomically debits the wallet balance. The WHERE clause checks both the expected version (optimistic lock) and sufficient balance. If either check fails, zero rows are updated and the function returns null.',
        sql: 'UPDATE wallets\nSET balance_cents = balance_cents - $2,\n    version = version + 1,\n    updated_at = NOW()\nWHERE user_id = $1\n  AND version = $3\n  AND balance_cents >= $2\nRETURNING id, user_id, balance_cents, version;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID' },
          { idx: '$2', name: 'amountCents', type: 'BIGINT', desc: 'Debit amount in cents (e.g. 100 = $1.00)' },
          { idx: '$3', name: 'expectedVersion', type: 'INTEGER', desc: 'Current version from last read \u2014 prevents lost updates' },
        ],
        source: 'backend/src/walletStore.ts \u2192 debitWallet()',
        returns: '{ id, user_id, balance_cents, version } or empty rowset (version mismatch / insufficient balance)',
        explain: 'Plan: Update on wallets\n  \u2192 Index Scan using wallets_user_id_key (UNIQUE)\n        Index Cond: (user_id = $1)\n  \u2192 Filter: (version = $3 AND balance_cents >= $2)\n  \u2192 If passes: update heap tuple, increment version\n  \u2192 If fails: 0 rows affected \u2192 function returns null\n\nOptimistic locking: no SELECT FOR UPDATE needed.\nThe version check prevents lost updates from concurrent requests.\nbalance_cents check prevents negative balance in one atomic step.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'Version mismatch (concurrent modification) or insufficient balance. The spin route retries or returns HTTP 422 { error: "Insufficient balance", code: "insufficient_balance" }.' },
        ],
      },
      {
        id: 'DML-09', category: 'dml', op: 'UPDATE',
        title: 'Credit wallet (win payout)',
        desc: 'Adds winnings to the wallet balance. No version check is needed because credits are always additive and cannot cause an invalid state. Version is still incremented for consistency.',
        sql: 'UPDATE wallets\nSET balance_cents = balance_cents + $2,\n    version = version + 1,\n    updated_at = NOW()\nWHERE user_id = $1\nRETURNING id, user_id, balance_cents, version;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID' },
          { idx: '$2', name: 'amountCents', type: 'BIGINT', desc: 'Credit amount in cents' },
        ],
        source: 'backend/src/walletStore.ts \u2192 creditWallet()',
        returns: '{ id, user_id, balance_cents, version }',
        explain: 'Plan: Update on wallets\n  \u2192 Index Scan using wallets_user_id_key (UNIQUE)\n        Index Cond: (user_id = $1)\n  \u2192 Update heap tuple, increment version\n\nNo version check needed \u2014 additive operations are safe\neven with concurrent access (no risk of negative balance).\nCost: O(1) single index probe.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'Wallet does not exist. Should never happen because getOrCreateWallet() is called first during game init.' },
        ],
      },
      {
        id: 'DML-10', category: 'dml', op: 'INSERT',
        title: 'Insert new seed pair (createSeedPair)',
        desc: 'Creates a new provably fair seed pair with a crypto-random server_seed and its SHA-256 hash. The client_seed defaults to "default" and nonce starts at 0.',
        sql: 'INSERT INTO seed_pairs (user_id, server_seed, server_seed_hash)\nVALUES ($1, $2, $3)\nRETURNING *;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID' },
          { idx: '$2', name: 'serverSeed', type: 'TEXT', desc: '64-char hex from crypto.randomBytes(32)' },
          { idx: '$3', name: 'serverSeedHash', type: 'TEXT', desc: 'SHA-256 hash of the server seed' },
        ],
        source: 'backend/src/seedStore.ts \u2192 createSeedPair()',
        returns: 'Full seed_pairs row (all columns)',
        explain: 'Plan: Insert on seed_pairs\n  \u2192 Result (generates UUID, sets defaults)\n  \u2192 FK check: users_pkey (verifies user_id exists)\n  \u2192 Insert heap tuple, update PK + composite indexes\n\nDefaults applied: client_seed=\'default\', nonce=0,\nactive=TRUE, revealed_at=NULL.\nCost: O(1) heap insert + index updates.',
        errors: [
          { code: '23503', type: 'pg', label: 'foreign_key_violation', text: 'user_id does not exist. Prevented by auth middleware.' },
        ],
      },
      {
        id: 'DML-11', category: 'dml', op: 'UPDATE',
        title: 'Rotate seed pair (deactivate + reveal)',
        desc: 'Deactivates the current active seed pair, revealing the server_seed by setting revealed_at to NOW(). After this, a new seed pair is created (DML-10). This enables users to verify past spins were fair.',
        sql: 'UPDATE seed_pairs\nSET active = FALSE, revealed_at = NOW()\nWHERE user_id = $1 AND active = TRUE\nRETURNING *;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID' },
        ],
        source: 'backend/src/seedStore.ts \u2192 rotateSeedPair()',
        returns: 'Deactivated seed pair row (with server_seed now visible) or empty rowset',
        explain: 'Plan: Update on seed_pairs\n  \u2192 Index Scan using idx_seed_pairs_user_active\n        Index Cond: (user_id = $1 AND active = TRUE)\n  \u2192 Update: active=FALSE, revealed_at=NOW()\n  \u2192 RETURNING reveals the previously hidden server_seed\n\nCost: O(log n) via composite index.\nAfter rotation, the old server_seed is visible\nfor HMAC verification against recorded outcomes.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'No active seed pair found. Function returns null for the previous field. A new pair is still created.' },
        ],
      },
      {
        id: 'DML-12', category: 'dml', op: 'BEGIN/COMMIT',
        title: 'Create round + transactions in a transaction (createRound)',
        desc: 'Inserts a game_rounds row and 1\u20132 transaction rows (bet + optional win) inside a BEGIN/COMMIT block. If any insert fails, the entire operation is rolled back to maintain consistency between rounds and their transactions.',
        sql: 'BEGIN;\n\nINSERT INTO game_rounds\n  (user_id, session_id, game_id, seed_pair_id, nonce,\n   bet_cents, win_cents, currency, lines,\n   balance_before_cents, balance_after_cents,\n   reel_matrix, win_breakdown, bonus_triggered, outcome_hash)\nVALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15)\nRETURNING *;\n\nINSERT INTO transactions\n  (round_id, user_id, type, amount_cents, balance_after_cents)\nVALUES ($16, $17, \'bet\', $18, $19);\n\n-- Only if win > 0:\nINSERT INTO transactions\n  (round_id, user_id, type, amount_cents, balance_after_cents)\nVALUES ($16, $17, \'win\', $20, $21);\n\nCOMMIT;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID' },
          { idx: '$2', name: 'sessionId', type: 'TEXT', desc: 'Game session identifier' },
          { idx: '$3', name: 'gameId', type: 'TEXT', desc: 'Game type identifier' },
          { idx: '$4', name: 'seedPairId', type: 'UUID', desc: 'Seed pair used for this spin (nullable)' },
          { idx: '$5', name: 'nonce', type: 'INTEGER', desc: 'Nonce at time of spin (nullable)' },
          { idx: '$6', name: 'betCents', type: 'BIGINT', desc: 'Bet amount in cents' },
          { idx: '$7', name: 'winCents', type: 'BIGINT', desc: 'Win amount in cents' },
          { idx: '$8', name: 'currency', type: 'TEXT', desc: 'Currency code' },
          { idx: '$9', name: 'lines', type: 'INTEGER', desc: 'Number of active paylines' },
          { idx: '$10', name: 'balanceBeforeCents', type: 'BIGINT', desc: 'Balance before spin' },
          { idx: '$11', name: 'balanceAfterCents', type: 'BIGINT', desc: 'Balance after spin' },
          { idx: '$12', name: 'reelMatrix', type: 'JSONB', desc: 'JSON-stringified 5x3 symbol grid' },
          { idx: '$13', name: 'winBreakdown', type: 'JSONB', desc: 'JSON array of winning paylines' },
          { idx: '$14', name: 'bonusTriggered', type: 'JSONB', desc: 'Bonus info or null' },
          { idx: '$15', name: 'outcomeHash', type: 'TEXT', desc: 'SHA-256 hash of outcome for verification' },
        ],
        source: 'backend/src/roundStore.ts \u2192 createRound()',
        returns: 'Full game_rounds row from RETURNING *',
        explain: 'Explicit transaction with pool.connect():\n  1. BEGIN \u2014 starts transaction\n  2. INSERT game_rounds \u2192 returns round with UUID\n  3. INSERT transactions (bet) \u2192 debit record\n  4. INSERT transactions (win) \u2192 credit record (if win > 0)\n  5. COMMIT \u2014 makes all changes visible\n  6. On error: ROLLBACK + re-throw\n\nAtomicity guarantees: either all 2\u20133 inserts succeed\nor none persist. Prevents orphaned transactions.',
        errors: [
          { code: '23503', type: 'pg', label: 'foreign_key_violation', text: 'user_id or seed_pair_id does not exist. Prevented by prior validation.' },
          { code: '23514', type: 'pg', label: 'check_violation', text: 'transactions.type is not \'bet\' or \'win\'. Prevented by hardcoded string literals in the code.' },
          { code: '40001', type: 'pg', label: 'serialization_failure', text: 'Rare under default READ COMMITTED isolation. Would trigger ROLLBACK and the error is re-thrown to the caller.' },
        ],
      },

      // ── DQL: Game History Queries ─────────────────────────────────────────
      {
        id: 'DQL-02', category: 'dql', op: 'SELECT',
        title: 'Get user rounds with dynamic filters (getUserRounds)',
        desc: 'Retrieves paginated game history for a user with optional filters: date range, win/loss result, min/max bet. Builds the WHERE clause dynamically based on provided filters. Includes a COUNT(*) for total pagination metadata.',
        sql: 'SELECT COUNT(*)::text AS count\nFROM game_rounds\nWHERE user_id = $1\n  AND created_at >= $2   -- if dateFrom\n  AND created_at <= $3   -- if dateTo\n  AND win_cents > bet_cents  -- if result=win\n  AND bet_cents >= $4    -- if minBet\n  AND bet_cents <= $5;   -- if maxBet\n\nSELECT * FROM game_rounds\nWHERE <same conditions>\nORDER BY created_at DESC\nLIMIT $N OFFSET $N+1;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID from JWT sub claim' },
          { idx: '$2', name: 'dateFrom', type: 'TEXT', desc: 'ISO 8601 start date (optional filter)' },
          { idx: '$3', name: 'dateTo', type: 'TEXT', desc: 'ISO 8601 end date (optional filter)' },
          { idx: '$N', name: 'limit', type: 'INTEGER', desc: 'Page size (default 50, max 100)' },
          { idx: '$N+1', name: 'offset', type: 'INTEGER', desc: 'Pagination offset (default 0)' },
        ],
        source: 'backend/src/roundStore.ts \u2192 getUserRounds()',
        returns: '{ items: GameRound[], total: number, limit: number, offset: number }',
        explain: 'Two queries: COUNT for total, SELECT for page.\nPlan: Index Scan using idx_game_rounds_user_created\n  Index Cond: (user_id = $1)\n  Filter: dynamic conditions (date, result, bet range)\n  Sort: created_at DESC (satisfied by index)\n  Limit: $N rows, Offset: $N+1 rows\n\nDynamic WHERE construction uses parameterised\nplaceholders \u2014 never string concatenation.\nCost: O(log n + k) where k = matching rows.',
        errors: [
          { code: '\u2014', type: 'app', label: 'empty result', text: 'No rounds match the filters. Returns { items: [], total: 0, limit, offset }. This is a valid response, not an error.' },
        ],
      },
      {
        id: 'DQL-03', category: 'dql', op: 'SELECT',
        title: 'Get round by ID with user scoping (getRoundById)',
        desc: 'Retrieves a single game round by its UUID, scoped to the authenticated user. The user_id check prevents IDOR (insecure direct object reference) attacks.',
        sql: 'SELECT * FROM game_rounds\nWHERE id = $1 AND user_id = $2;',
        params: [
          { idx: '$1', name: 'roundId', type: 'UUID', desc: 'Game round UUID from the URL path parameter' },
          { idx: '$2', name: 'userId', type: 'UUID', desc: 'Authenticated user UUID from JWT' },
        ],
        source: 'backend/src/roundStore.ts \u2192 getRoundById()',
        returns: 'Full game_rounds row or empty rowset (not found / not owned)',
        explain: 'Plan: Index Scan using game_rounds_pkey\n  Index Cond: (id = $1)\n  Filter: (user_id = $2)\n\nThe PK index lookup is O(1). The user_id filter\nis applied post-lookup on the single heap tuple.\nIDOR prevention: even if an attacker guesses\na valid round UUID, they cannot access it without\nmatching the user_id from their JWT.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'Round not found or belongs to another user. Function returns null \u2192 route returns HTTP 404 { error: "Round not found", code: "round_not_found" }.' },
        ],
      },
      {
        id: 'DQL-04', category: 'dql', op: 'SELECT',
        title: 'Aggregate user summary (getUserSummary)',
        desc: 'Computes aggregate statistics for a user\'s game history: total rounds, total wagered, total won, and biggest single win. Uses COUNT, SUM, MAX, and COALESCE for null-safe aggregation. Supports the same dynamic filters as DQL-02.',
        sql: 'SELECT\n  COUNT(*)::text AS total_rounds,\n  COALESCE(SUM(bet_cents), 0)::text AS total_wagered,\n  COALESCE(SUM(win_cents), 0)::text AS total_won,\n  COALESCE(MAX(win_cents), 0)::text AS biggest_win\nFROM game_rounds\nWHERE user_id = $1;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID from JWT' },
        ],
        source: 'backend/src/roundStore.ts \u2192 getUserSummary()',
        returns: '{ total_rounds, total_wagered, total_won, biggest_win } \u2014 cents converted to dollars at the application layer',
        explain: 'Plan: Aggregate\n  \u2192 Index Scan using idx_game_rounds_user_created\n        Index Cond: (user_id = $1)\n  \u2192 COUNT(*) counts all matching rows\n  \u2192 SUM(bet_cents) / SUM(win_cents) for totals\n  \u2192 MAX(win_cents) for biggest win\n  \u2192 COALESCE handles NULL when no rows match\n  \u2192 ::text cast avoids JS integer overflow for large sums\n\nnet_result = (total_won - total_wagered) / 100\ncomputed in application code.',
        errors: [
          { code: '\u2014', type: 'app', label: 'no rows', text: 'If user has no rounds, COUNT returns 0 and SUM/MAX return NULL. COALESCE converts NULL to 0 \u2014 no error case.' },
        ],
      },
      {
        id: 'DQL-05', category: 'dql', op: 'SELECT',
        title: 'Get transactions for a round (getRoundTransactions)',
        desc: 'Retrieves all transactions (bet and win) for a specific round, ordered chronologically. Typically returns 1\u20132 rows.',
        sql: 'SELECT * FROM transactions\nWHERE round_id = $1\nORDER BY created_at ASC;',
        params: [
          { idx: '$1', name: 'roundId', type: 'UUID', desc: 'Game round UUID' },
        ],
        source: 'backend/src/roundStore.ts \u2192 getRoundTransactions()',
        returns: 'Transaction[] \u2014 array of { id, round_id, user_id, type, amount_cents, balance_after_cents, created_at }',
        explain: 'Plan: Index Scan on transactions\n  \u2192 Filter: (round_id = $1)\n  \u2192 Sort: created_at ASC\n\nTypically returns 1 (loss) or 2 (bet + win) rows.\nSmall result set makes sort negligible.\nCost: O(log n) index probe + sequential read of matching rows.',
        errors: [],
      },
      {
        id: 'DQL-06', category: 'dql', op: 'SELECT',
        title: 'Get active seed pair (getActiveSeedPair)',
        desc: 'Retrieves the currently active seed pair for a user. At most one seed pair is active per user at any time. Returns the server_seed_hash (visible) but the server_seed itself is only returned after rotation.',
        sql: 'SELECT * FROM seed_pairs\nWHERE user_id = $1 AND active = TRUE\nLIMIT 1;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID from JWT' },
        ],
        source: 'backend/src/seedStore.ts \u2192 getActiveSeedPair()',
        returns: 'Full seed_pairs row or null (no active pair)',
        explain: 'Plan: Index Scan using idx_seed_pairs_user_active\n  Index Cond: (user_id = $1 AND active = TRUE)\n  Limit: 1 row\n\nCost: O(log n) single composite index probe.\nThe LIMIT 1 stops after the first match.\nNote: server_seed is in the row but the API layer\nstrips it from the response while the pair is active.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'No active seed pair. Function returns null. getOrCreateActiveSeedPair() will then create a new pair via DML-10.' },
        ],
      },
    ];

    /* ======================================================================= */
    /*  RENDER HELPERS                                                         */
    /* ======================================================================= */
    const listEl     = document.getElementById('query-list');
    const qiGrid     = document.getElementById('qi-grid');
    const countLabel  = document.getElementById('count-label');
    const statsEl     = document.getElementById('stats');
    const searchInput = document.getElementById('search');

    const CAT_LABELS = { ddl: 'DDL', dml: 'DML', dql: 'DQL' };
    const CAT_BADGE  = { ddl: 'badge-ddl', dml: 'badge-dml', dql: 'badge-dql' };
    const OP_CLASS   = {
      SELECT: 'op-select', INSERT: 'op-insert', DELETE: 'op-delete',
      UPDATE: 'op-insert',
      'CREATE TABLE': 'op-create', 'CREATE INDEX': 'op-create',
      BATCH: 'op-create', TRUNCATE: 'op-truncate',
      'INSERT/UPDATE': 'op-insert', 'BEGIN/COMMIT': 'op-create',
    };
    const ERR_TYPE_CLASS = { pg: 'error-code-pg', http: 'error-code-http', app: 'error-code-app' };

    // ── Stats ─────────────────────────────────────────────────────────────────
    const total = QUERIES.length;
    const ddlCount = QUERIES.filter(q => q.category === 'ddl').length;
    const dmlCount = QUERIES.filter(q => q.category === 'dml').length;
    const dqlCount = QUERIES.filter(q => q.category === 'dql').length;
    const paramCount = QUERIES.reduce((s, q) => s + q.params.length, 0);

    statsEl.innerHTML = `
      <div class="stat"><strong>${total}</strong>Queries</div>
      <div class="stat"><strong>${ddlCount}</strong>DDL</div>
      <div class="stat"><strong>${dmlCount}</strong>DML</div>
      <div class="stat"><strong>${dqlCount}</strong>DQL</div>
      <div class="stat"><strong>${paramCount}</strong>Bind params</div>
      <div class="stat"><strong>0</strong>Raw SQL concat</div>
    `;

    // ── SQL Syntax Highlighting ───────────────────────────────────────────────
    function hl(raw) {
      return raw
        .replace(/(--[^\n]*)/g, '<span class="cmt">$1</span>')
        .replace(/\b(CREATE TABLE|CREATE INDEX|IF NOT EXISTS|PRIMARY KEY|DEFAULT|UNIQUE|NOT NULL|REFERENCES|ON DELETE CASCADE|INSERT INTO|VALUES|RETURNING|DELETE FROM|WHERE|SELECT|FROM|TRUNCATE TABLE|CASCADE|AND|OR|SET|BATCH|UPDATE|BEGIN|COMMIT|ROLLBACK|LIMIT|OFFSET|ORDER BY|ON CONFLICT|DO UPDATE|CHECK|COUNT|SUM|MAX|COALESCE)\b/gi, '<span class="kw">$1</span>')
        .replace(/\b(gen_random_uuid|NOW|interval)\b/gi, '<span class="fn">$1</span>')
        .replace(/\b(UUID|TEXT|TIMESTAMPTZ|BOOLEAN|INTEGER|BIGINT|JSONB)\b/g, '<span class="type">$1</span>')
        .replace(/\b(users|refresh_tokens|wallets|seed_pairs|game_rounds|transactions)\b/g, '<span class="tbl">$1</span>')
        .replace(/'([^']*)'/g, "'<span class=\"str\">$1</span>'")
        .replace(/(\$\d+)/g, '<span class="param">$1</span>');
    }

    function hlExplain(raw) {
      return raw
        .replace(/\b(Index Scan|Index Scan Backward|Seq Scan|Insert|Delete|Update|Aggregate|Result|Filter|Index Cond|Constraint check|Plan|Cost|FK check|Sort|Limit|Offset)\b/g, '<span class="ex-node">$1</span>')
        .replace(/(O\([^)]+\))/g, '<span class="ex-cost">$1</span>')
        .replace(/\b(idx_\w+|users_email_key|refresh_tokens_pkey|wallets_user_id_key|game_rounds_pkey)\b/g, '<span class="ex-note">$1</span>');
    }

    // ── Query Index ───────────────────────────────────────────────────────────
    function buildIndex() {
      qiGrid.innerHTML = QUERIES.map((q, i) => `
        <a class="qi-item" data-target="${i}">
          <span class="qi-id">${q.id}</span>
          <span class="qi-title">${q.title}</span>
          <span class="qi-op op-badge ${OP_CLASS[q.op] || ''}">${q.op}</span>
        </a>
      `).join('');
    }
    buildIndex();

    // Jump to card on index click
    qiGrid.addEventListener('click', (e) => {
      const item = e.target.closest('.qi-item');
      if (!item) return;
      const idx = parseInt(item.dataset.target);
      const card = document.querySelector(`.query-card[data-idx="${idx}"]`);
      if (!card) return;

      // close all, open target
      document.querySelectorAll('.query-card.open').forEach(c => c.classList.remove('open'));
      card.classList.add('open');
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // brief highlight
      card.classList.add('highlight');
      setTimeout(() => card.classList.remove('highlight'), 1500);
    });

    // ── Build Query Cards ─────────────────────────────────────────────────────
    function buildCards() {
      listEl.innerHTML = QUERIES.map((q, i) => `
        <div class="query-card" data-idx="${i}" data-category="${q.category}" id="q-${q.id}">
          <div class="query-header" data-idx="${i}">
            <span class="query-chevron">&#9654;</span>
            <span class="query-id">${q.id}</span>
            <span class="query-title">${q.title}</span>
            <div class="query-meta">
              <span class="badge ${CAT_BADGE[q.category]}">${CAT_LABELS[q.category]}</span>
              <span class="op-badge ${OP_CLASS[q.op] || ''}">${q.op}</span>
            </div>
          </div>
          <div class="query-body">
            <div class="query-desc">${q.desc}</div>

            <div class="sql-block"><button class="copy-btn" data-idx="${i}">Copy</button>${hl(q.sql)}</div>

            ${q.params.length > 0 ? `
            <div class="detail-field" style="margin-bottom:14px">
              <span class="detail-label">Bind Parameters</span>
              <div class="detail-value" style="padding:0; overflow:hidden">
                <table class="param-table">
                  <thead><tr><th>Param</th><th>Name</th><th>Type</th><th>Description</th></tr></thead>
                  <tbody>
                    ${q.params.map(p => `<tr>
                      <td><span class="param-idx">${p.idx}</span></td>
                      <td><span class="param-name">${p.name}</span></td>
                      <td><span class="param-type">${p.type}</span></td>
                      <td>${p.desc}</td>
                    </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>` : ''}

            <div class="detail-grid">
              <div class="detail-field">
                <span class="detail-label">Returns</span>
                <div class="detail-value"><code>${q.returns}</code></div>
              </div>
              <div class="detail-field">
                <span class="detail-label">Source File</span>
                <div class="detail-value"><code>${q.source}</code></div>
              </div>

              <div class="detail-field full">
                <span class="detail-label">Execution Plan &amp; Performance</span>
                <div class="explain-block">${hlExplain(q.explain)}</div>
              </div>

              ${q.errors.length > 0 ? `
              <div class="detail-field full">
                <span class="detail-label">Error Handling</span>
                <div class="detail-value" style="padding:8px">
                  <ul class="error-list">
                    ${q.errors.map(e => `<li class="error-item">
                      <span class="error-code ${ERR_TYPE_CLASS[e.type] || 'error-code-app'}">${e.code}</span>
                      <span class="error-text">${e.text}</span>
                    </li>`).join('')}
                  </ul>
                </div>
              </div>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }
    buildCards();

    /* ======================================================================= */
    /*  INTERACTIVITY                                                          */
    /* ======================================================================= */

    // Expand / collapse
    listEl.addEventListener('click', (e) => {
      if (e.target.closest('.copy-btn')) return;
      const header = e.target.closest('.query-header');
      if (!header) return;

      const card = header.closest('.query-card');
      const wasOpen = card.classList.contains('open');

      document.querySelectorAll('.query-card.open').forEach(c => c.classList.remove('open'));
      if (!wasOpen) card.classList.add('open');
    });

    // Copy button
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.copy-btn');
      if (!btn) return;
      e.stopPropagation();
      const idx = parseInt(btn.dataset.idx);
      navigator.clipboard.writeText(QUERIES[idx].sql).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
      });
    });

    // Filter tabs
    let activeFilter = 'all';
    document.getElementById('filters').addEventListener('click', (e) => {
      const tab = e.target.closest('.tab');
      if (!tab) return;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      activeFilter = tab.dataset.filter;
      applyFilters();
    });

    // Search
    searchInput.addEventListener('input', () => applyFilters());

    function applyFilters() {
      const q = searchInput.value.toLowerCase().trim();
      let visible = 0;

      document.querySelectorAll('.query-card').forEach(card => {
        const idx = parseInt(card.dataset.idx);
        const query = QUERIES[idx];

        const matchCat = activeFilter === 'all' || query.category === activeFilter;
        const matchSearch = !q ||
          query.id.toLowerCase().includes(q) ||
          query.title.toLowerCase().includes(q) ||
          query.desc.toLowerCase().includes(q) ||
          query.sql.toLowerCase().includes(q) ||
          query.op.toLowerCase().includes(q);

        const show = matchCat && matchSearch;
        card.style.display = show ? '' : 'none';
        if (show) visible++;
      });

      countLabel.textContent = `${visible} of ${total}`;
    }

    applyFilters();

    // Open card if URL has hash like #q-DML-01
    if (location.hash && location.hash.startsWith('#q-')) {
      const el = document.getElementById(location.hash.slice(1));
      if (el) {
        el.classList.add('open');
        setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
      }
    }
    </script>
  </body>
</html>
