<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQL Reference — pyavchik.space</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(180deg, #0f1118 0%, #0b0d13 100%);
        color: #f8fafc;
        min-height: 100vh;
        font-size: 14px;
      }

      .wrap {
        max-width: 1080px;
        margin: 0 auto;
        padding: 28px 18px 56px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* ── Cards ───────────────────────────────────── */
      .card {
        border: 1px solid rgba(255,255,255,0.13);
        border-radius: 14px;
        background: rgba(17,20,30,0.78);
        padding: 20px 22px;
      }

      h1 { margin: 0 0 3px; font-size: 26px; letter-spacing: -.3px; }
      .subtitle { margin: 0 0 14px; color: #94a3b8; font-size: 13px; }
      h2 { margin: 0 0 14px; font-size: 16px; color: #f1f5f9; }
      h3 { margin: 0 0 10px; font-size: 14px; color: #e2e8f0; }
      p  { margin: 0 0 10px; color: #dbe2ec; line-height: 1.55; }

      /* ── Back link ───────────────────────────────── */
      .back {
        display: inline-flex; align-items: center; gap: 6px;
        font-size: 13px; font-weight: 600; color: #94a3b8;
        text-decoration: none;
        border: 1px solid rgba(148,163,184,.3);
        padding: 6px 12px; border-radius: 8px;
        background: rgba(15,23,42,.5);
        width: fit-content;
      }
      .back:hover { color: #f8fafc; border-color: rgba(148,163,184,.7); }

      /* ── Stats ───────────────────────────────────── */
      .stats { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .stat {
        padding: 8px 14px; border-radius: 10px;
        background: rgba(15,23,42,.65);
        border: 1px solid rgba(148,163,184,.2);
        font-size: 13px; color: #dbe2ec; text-align: center;
      }
      .stat strong { display: block; font-size: 22px; line-height: 1.15; color: #f8fafc; }

      /* ── ERD Tables ─────────────────────────────── */
      .erd-wrap {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 0;
        align-items: start;
        margin-bottom: 16px;
      }
      .erd-table {
        border: 1px solid rgba(148,163,184,.25);
        border-radius: 10px;
        overflow: hidden;
        background: rgba(15,23,42,.55);
      }
      .erd-table-head {
        padding: 10px 14px;
        background: rgba(15,23,42,.8);
        border-bottom: 1px solid rgba(148,163,184,.2);
        font-weight: 700; font-size: 14px;
        display: flex; align-items: center; gap: 8px;
      }
      .erd-table-head .tbl-icon {
        width: 18px; height: 18px; border-radius: 4px;
        display: inline-flex; align-items: center; justify-content: center;
        font-size: 10px; font-weight: 800;
      }
      .erd-tbl-users .tbl-icon { background: rgba(56,189,248,.2); color: #38bdf8; }
      .erd-tbl-tokens .tbl-icon { background: rgba(245,208,106,.2); color: #f5d06a; }

      .erd-cols { width: 100%; border-collapse: collapse; }
      .erd-cols td {
        padding: 6px 14px;
        border-bottom: 1px solid rgba(255,255,255,.05);
        font-size: 13px; color: #dbe2ec;
        vertical-align: top;
      }
      .erd-cols tr:last-child td { border-bottom: none; }
      .erd-col-name {
        font-family: ui-monospace, monospace; font-size: 12px;
        color: #f1f5f9; white-space: nowrap;
      }
      .erd-col-type {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #3ee0a9; white-space: nowrap;
      }
      .erd-col-constraint {
        font-size: 10px; font-weight: 700; letter-spacing: .03em;
        white-space: nowrap;
      }
      .erd-pk { color: #38bdf8; }
      .erd-fk { color: #f87171; }
      .erd-uq { color: #a78bfa; }
      .erd-nn { color: #64748b; }
      .erd-def { color: #94a3b8; font-size: 11px; font-family: ui-monospace, monospace; }

      .erd-rel {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0 8px;
        min-height: 120px;
        position: relative;
      }
      .erd-rel-line {
        width: 100%; min-width: 40px; height: 2px;
        background: rgba(148,163,184,.35);
        position: relative;
        margin-top: 30px;
      }
      .erd-rel-line::before {
        content: '1'; position: absolute; left: -2px; top: -18px;
        font-size: 11px; font-weight: 700; color: #94a3b8;
      }
      .erd-rel-line::after {
        content: 'N'; position: absolute; right: -2px; top: -18px;
        font-size: 11px; font-weight: 700; color: #94a3b8;
      }
      .erd-rel-label {
        font-size: 10px; color: #64748b; margin-top: 6px;
        text-align: center; white-space: nowrap;
      }

      .erd-indexes {
        margin-top: 8px; padding: 8px 14px;
        border-top: 1px solid rgba(148,163,184,.15);
        font-size: 11px; color: #64748b;
      }
      .erd-indexes code {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #94a3b8;
      }

      /* ── Controls ────────────────────────────────── */
      .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }

      .filter-tabs { display: flex; flex-wrap: wrap; gap: 6px; flex: 1; }
      .tab {
        padding: 6px 14px; border-radius: 999px;
        border: 1px solid rgba(148,163,184,.3);
        background: transparent; color: #94a3b8;
        font-size: 12px; font-weight: 700; cursor: pointer;
        transition: border-color .15s, color .15s, background .15s;
        white-space: nowrap;
      }
      .tab:hover { border-color: rgba(248,250,252,.5); color: #f8fafc; }
      .tab.active {
        border-color: rgba(248,250,252,.7); color: #f8fafc;
        background: rgba(248,250,252,.08);
      }

      .search-wrap { position: relative; }
      .search-wrap svg {
        position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
        color: #64748b; pointer-events: none;
      }
      #search {
        padding: 7px 10px 7px 32px; border-radius: 8px;
        border: 1px solid rgba(148,163,184,.3);
        background: rgba(15,23,42,.65); color: #f8fafc;
        font-size: 13px; width: 220px; outline: none;
      }
      #search:focus { border-color: rgba(148,163,184,.7); }
      #search::placeholder { color: #475569; }

      .count-label { font-size: 12px; color: #475569; white-space: nowrap; }

      /* ── Query Index ────────────────────────────── */
      .qi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 6px;
      }
      .qi-item {
        display: flex; align-items: center; gap: 8px;
        padding: 7px 12px; border-radius: 8px;
        background: rgba(15,23,42,.45);
        border: 1px solid rgba(148,163,184,.1);
        text-decoration: none;
        transition: border-color .15s, background .15s;
        cursor: pointer;
      }
      .qi-item:hover {
        border-color: rgba(148,163,184,.35);
        background: rgba(15,23,42,.7);
      }
      .qi-id {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #38bdf8; white-space: nowrap; flex-shrink: 0;
        min-width: 48px;
      }
      .qi-title {
        font-size: 12px; color: #dbe2ec; line-height: 1.35;
        flex: 1;
      }
      .qi-op {
        font-size: 9px; font-weight: 800; letter-spacing: .04em;
        padding: 1px 5px; border-radius: 4px; white-space: nowrap; flex-shrink: 0;
      }

      /* ── Badges ──────────────────────────────────── */
      .badge {
        display: inline-block; padding: 2px 7px;
        border-radius: 5px; font-size: 11px; font-weight: 700;
        white-space: nowrap; letter-spacing: .02em;
      }
      .badge-ddl  { background: rgba(56,189,248,.15);  color: #38bdf8; }
      .badge-dml  { background: rgba(245,208,106,.15); color: #f5d06a; }
      .badge-dql  { background: rgba(62,224,169,.15);  color: #3ee0a9; }

      .op-badge {
        display: inline-block; padding: 2px 7px;
        border-radius: 5px; font-size: 10px; font-weight: 800;
        letter-spacing: .04em; white-space: nowrap;
      }
      .op-select   { background: rgba(62,224,169,.12);  color: #3ee0a9; }
      .op-insert   { background: rgba(56,189,248,.12);  color: #38bdf8; }
      .op-delete   { background: rgba(248,113,113,.12); color: #f87171; }
      .op-create   { background: rgba(245,208,106,.12); color: #f5d06a; }
      .op-truncate { background: rgba(148,163,184,.12); color: #94a3b8; }

      /* ── Query cards ────────────────────────────── */
      .query-list { display: flex; flex-direction: column; gap: 12px; }

      .query-card {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        background: rgba(11,13,19,.5);
        overflow: hidden;
        transition: border-color .15s;
        scroll-margin-top: 16px;
      }
      .query-card:hover { border-color: rgba(255,255,255,.16); }
      .query-card.highlight { border-color: rgba(56,189,248,.5); }

      .query-header {
        display: flex; align-items: center; gap: 10px;
        padding: 14px 16px;
        cursor: pointer;
        user-select: none;
      }
      .query-header:hover { background: rgba(255,255,255,.03); }

      .query-chevron {
        color: #475569; transition: transform .2s;
        flex-shrink: 0; font-size: 10px;
      }
      .query-card.open .query-chevron { transform: rotate(90deg); }

      .query-id {
        font-family: ui-monospace, monospace; font-size: 12px;
        color: #38bdf8; white-space: nowrap; flex-shrink: 0;
      }

      .query-title {
        flex: 1; color: #f1f5f9; font-size: 13px; font-weight: 600;
        line-height: 1.4;
      }

      .query-meta {
        display: flex; gap: 6px; align-items: center; flex-shrink: 0;
      }

      .query-body {
        display: none;
        padding: 0 16px 18px 16px;
      }
      .query-card.open .query-body { display: block; }

      .query-desc {
        color: #94a3b8; font-size: 13px; line-height: 1.55;
        margin-bottom: 14px;
      }

      /* ── SQL code block ─────────────────────────── */
      .sql-block {
        position: relative;
        font-family: ui-monospace, "Cascadia Code", "Fira Code", Menlo, monospace;
        font-size: 13px; line-height: 1.6;
        padding: 16px 18px;
        border-radius: 10px;
        background: rgba(15,23,42,.7);
        border: 1px solid rgba(148,163,184,.12);
        overflow-x: auto;
        white-space: pre;
        color: #e2e8f0;
        margin-bottom: 14px;
        tab-size: 2;
      }
      .sql-block .kw    { color: #38bdf8; font-weight: 700; }
      .sql-block .fn    { color: #a78bfa; }
      .sql-block .str   { color: #f5d06a; }
      .sql-block .param { color: #f87171; font-weight: 700; }
      .sql-block .cmt   { color: #475569; font-style: italic; }
      .sql-block .type  { color: #3ee0a9; }
      .sql-block .tbl   { color: #fbbf24; }

      .copy-btn {
        position: absolute; top: 8px; right: 8px;
        padding: 4px 10px; border-radius: 6px;
        border: 1px solid rgba(148,163,184,.25);
        background: rgba(15,23,42,.8); color: #94a3b8;
        font-size: 11px; font-weight: 600; cursor: pointer;
        transition: color .15s, border-color .15s;
      }
      .copy-btn:hover { color: #f8fafc; border-color: rgba(148,163,184,.6); }

      /* ── Detail fields ──────────────────────────── */
      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .detail-grid .full { grid-column: 1 / -1; }

      .detail-field { display: flex; flex-direction: column; gap: 5px; }
      .detail-label {
        font-size: 10px; font-weight: 700; text-transform: uppercase;
        letter-spacing: .08em; color: #64748b;
      }
      .detail-value {
        color: #dbe2ec; line-height: 1.5; font-size: 13px;
        padding: 8px 10px; border-radius: 8px;
        background: rgba(15,23,42,.55);
        border: 1px solid rgba(148,163,184,.12);
      }
      .detail-value code {
        font-family: ui-monospace, monospace;
        font-size: 12px; color: #a78bfa;
        background: rgba(167,139,250,.1);
        padding: 1px 4px; border-radius: 3px;
      }

      .param-table {
        width: 100%; border-collapse: collapse;
        font-size: 13px;
      }
      .param-table th {
        text-align: left; padding: 6px 10px;
        font-size: 10px; font-weight: 700; text-transform: uppercase;
        letter-spacing: .06em; color: #64748b;
        border-bottom: 1px solid rgba(255,255,255,.08);
      }
      .param-table td {
        padding: 6px 10px;
        border-bottom: 1px solid rgba(255,255,255,.04);
        color: #dbe2ec;
      }
      .param-table tr:last-child td { border-bottom: none; }
      .param-idx {
        font-family: ui-monospace, monospace; font-size: 12px;
        font-weight: 700; color: #f87171;
      }
      .param-name {
        font-family: ui-monospace, monospace; font-size: 12px;
        color: #f1f5f9;
      }
      .param-type {
        font-family: ui-monospace, monospace; font-size: 11px;
        color: #3ee0a9;
      }

      /* ── Explain block ──────────────────────────── */
      .explain-block {
        font-family: ui-monospace, monospace;
        font-size: 12px; line-height: 1.55;
        padding: 12px 14px;
        border-radius: 8px;
        background: rgba(15,23,42,.65);
        border: 1px solid rgba(148,163,184,.1);
        color: #94a3b8;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .explain-block .ex-node { color: #38bdf8; }
      .explain-block .ex-cost { color: #f5d06a; }
      .explain-block .ex-note { color: #3ee0a9; }

      /* ── Error handling block ───────────────────── */
      .error-list {
        margin: 0; padding: 0; list-style: none;
        display: flex; flex-direction: column; gap: 8px;
      }
      .error-item {
        display: flex; gap: 10px; align-items: flex-start;
        padding: 8px 10px; border-radius: 8px;
        background: rgba(15,23,42,.4);
        border: 1px solid rgba(148,163,184,.08);
      }
      .error-code {
        font-family: ui-monospace, monospace; font-size: 11px;
        font-weight: 700; white-space: nowrap; flex-shrink: 0;
        padding: 2px 6px; border-radius: 4px;
        min-width: 40px; text-align: center;
      }
      .error-code-pg { background: rgba(248,113,113,.12); color: #f87171; }
      .error-code-http { background: rgba(245,208,106,.12); color: #f5d06a; }
      .error-code-app { background: rgba(167,139,250,.12); color: #a78bfa; }
      .error-text { font-size: 13px; color: #dbe2ec; line-height: 1.45; }

      /* ── Info grid ──────────────────────────────── */
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .info-item {
        padding: 10px 14px; border-radius: 10px;
        background: rgba(15,23,42,.55);
        border: 1px solid rgba(148,163,184,.12);
      }
      .info-item dt {
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        letter-spacing: .06em; color: #38bdf8; margin-bottom: 4px;
      }
      .info-item dd {
        margin: 0; color: #dbe2ec; font-size: 13px; line-height: 1.5;
      }

      /* ── Responsive ─────────────────────────────── */
      @media (max-width: 640px) {
        .erd-wrap { grid-template-columns: 1fr; gap: 10px; }
        .erd-rel { flex-direction: row; min-height: auto; padding: 4px 0; }
        .erd-rel-line { width: 2px; height: 30px; min-width: 2px; margin-top: 0; }
        .info-grid { grid-template-columns: 1fr; }
        .detail-grid { grid-template-columns: 1fr; }
        #search { width: 100%; }
        .controls { flex-direction: column; align-items: stretch; }
        .query-meta { display: none; }
        .qi-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">

      <!-- Back link -->
      <a class="back" href="/">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Back to CV
      </a>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- HEADER                                                               -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h1>SQL Reference</h1>
        <p class="subtitle">SlotsOne — PostgreSQL 16 Database Layer &nbsp;|&nbsp; v1.0 &nbsp;|&nbsp; Last updated: 2026-02-28</p>

        <p>Complete reference of every SQL statement executed by the SlotsOne backend.
           All queries use parameterised placeholders (<code style="color:#f87171">$1, $2, &hellip;</code>) via the
           <code>pg</code> driver to prevent SQL injection. No raw string concatenation is ever used.</p>

        <div class="stats" id="stats"></div>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- SCHEMA ERD                                                           -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Database Schema (ERD)</h2>
        <p>Two tables managed by <code>001_init.sql</code>, executed on every server startup via <code>initDb()</code>.
           All DDL uses <code>IF NOT EXISTS</code> for idempotency.</p>

        <div class="erd-wrap">
          <!-- users table -->
          <div class="erd-table erd-tbl-users">
            <div class="erd-table-head">
              <span class="tbl-icon">U</span>
              users
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td><span class="erd-def">gen_random_uuid()</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">email</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-uq">UNIQUE</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">password_hash</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
          </div>

          <!-- relationship -->
          <div class="erd-rel">
            <div class="erd-rel-line"></div>
            <div class="erd-rel-label">ON DELETE CASCADE</div>
          </div>

          <!-- refresh_tokens table -->
          <div class="erd-table erd-tbl-tokens">
            <div class="erd-table-head">
              <span class="tbl-icon">T</span>
              refresh_tokens
            </div>
            <table class="erd-cols">
              <tr>
                <td><span class="erd-col-name">token</span></td>
                <td><span class="erd-col-type">TEXT</span></td>
                <td><span class="erd-col-constraint erd-pk">PK</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">user_id</span></td>
                <td><span class="erd-col-type">UUID</span></td>
                <td><span class="erd-col-constraint erd-fk">FK</span> <span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">&rarr; users(id)</span></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">expires_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td></td>
              </tr>
              <tr>
                <td><span class="erd-col-name">created_at</span></td>
                <td><span class="erd-col-type">TIMESTAMPTZ</span></td>
                <td><span class="erd-col-constraint erd-nn">NOT NULL</span></td>
                <td><span class="erd-def">NOW()</span></td>
              </tr>
            </table>
            <div class="erd-indexes">
              <code>idx_refresh_tokens_user_id</code> B-tree on <code>user_id</code><br>
              <code>idx_refresh_tokens_expires_at</code> B-tree on <code>expires_at</code>
            </div>
          </div>
        </div>

        <h3>Connection Pool</h3>
        <dl class="info-grid">
          <div class="info-item"><dt>Driver</dt><dd><code>pg.Pool</code> (node-postgres) &mdash; singleton, lazily initialised</dd></div>
          <div class="info-item"><dt>Max Connections</dt><dd>10 concurrent connections</dd></div>
          <div class="info-item"><dt>Idle Timeout</dt><dd>30 000 ms (30 s)</dd></div>
          <div class="info-item"><dt>Connect Timeout</dt><dd>5 000 ms (5 s)</dd></div>
        </dl>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- QUERY INDEX                                                          -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Query Index</h2>
        <p style="margin-bottom:12px">Click any row to jump to the full query detail.</p>
        <div class="qi-grid" id="qi-grid">
          <!-- filled by JS -->
        </div>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- CONTROLS                                                             -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <div class="controls">
          <div class="filter-tabs" id="filters">
            <button class="tab active" data-filter="all">All</button>
            <button class="tab" data-filter="ddl">DDL</button>
            <button class="tab" data-filter="dml">DML</button>
            <button class="tab" data-filter="dql">DQL</button>
          </div>
          <div class="search-wrap">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="search" placeholder="Search queries..." />
          </div>
          <span class="count-label" id="count-label"></span>
        </div>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- QUERY LIST                                                           -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="query-list" id="query-list">
        <!-- filled by JS -->
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- SECURITY & BEST PRACTICES                                            -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Security &amp; Best Practices</h2>
        <dl class="info-grid">
          <div class="info-item">
            <dt>Parameterised Queries</dt>
            <dd>Every user-supplied value is passed as a <code>$N</code> placeholder argument &mdash; never concatenated into SQL strings. This eliminates SQL injection vectors.</dd>
          </div>
          <div class="info-item">
            <dt>Atomic Token Rotation</dt>
            <dd><code>DELETE &hellip; RETURNING</code> consumes a refresh token and retrieves the owner in a single atomic statement, preventing race conditions and replay attacks.</dd>
          </div>
          <div class="info-item">
            <dt>Cascade Deletion</dt>
            <dd>The <code>refresh_tokens.user_id</code> FK uses <code>ON DELETE CASCADE</code> &mdash; deleting a user automatically purges all their tokens.</dd>
          </div>
          <div class="info-item">
            <dt>Unique Constraints</dt>
            <dd>The <code>users.email</code> column has a <code>UNIQUE</code> constraint. The app catches PostgreSQL error code <code>23505</code> and returns a 409 Conflict.</dd>
          </div>
          <div class="info-item">
            <dt>Server-Side TTL</dt>
            <dd>Token expiration is computed by the database: <code>NOW() + interval '7 days'</code>, avoiding clock-skew between Node.js and PostgreSQL.</dd>
          </div>
          <div class="info-item">
            <dt>Idempotent Migrations</dt>
            <dd>All DDL uses <code>CREATE TABLE IF NOT EXISTS</code> and <code>CREATE INDEX IF NOT EXISTS</code> &mdash; safe to run repeatedly on every server start.</dd>
          </div>
          <div class="info-item">
            <dt>Index Coverage</dt>
            <dd>B-tree indexes on <code>refresh_tokens(user_id)</code> and <code>refresh_tokens(expires_at)</code> ensure O(log&nbsp;n) lookups for validation and cleanup.</dd>
          </div>
          <div class="info-item">
            <dt>Graceful Shutdown</dt>
            <dd><code>closePool()</code> drains active connections and resets the singleton reference, preventing connection leaks on restart.</dd>
          </div>
        </dl>
      </div>

      <!-- ────────────────────────────────────────────────────────────────────── -->
      <!-- SOURCE FILES                                                         -->
      <!-- ────────────────────────────────────────────────────────────────────── -->
      <div class="card">
        <h2>Source Files</h2>
        <dl class="info-grid">
          <div class="info-item"><dt>Migration</dt><dd><code>backend/src/migrations/001_init.sql</code></dd></div>
          <div class="info-item"><dt>Connection Pool</dt><dd><code>backend/src/db.ts</code></dd></div>
          <div class="info-item"><dt>User Store</dt><dd><code>backend/src/userStore.ts</code></dd></div>
          <div class="info-item"><dt>Token Store</dt><dd><code>backend/src/auth/refreshTokenStore.ts</code></dd></div>
        </dl>
      </div>

    </div>

    <script>
    /* ======================================================================= */
    /*  QUERY DATA                                                             */
    /* ======================================================================= */
    const QUERIES = [
      // ── DDL ─────────────────────────────────────────────────────────────────
      {
        id: 'DDL-01', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create users table',
        desc: 'Creates the users table with a UUID primary key (auto-generated via gen_random_uuid()), a unique email column, a scrypt password hash, and a creation timestamp. IF NOT EXISTS makes the statement idempotent.',
        sql: 'CREATE TABLE IF NOT EXISTS users (\n  id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n  email         TEXT        UNIQUE NOT NULL,\n  password_hash TEXT        NOT NULL,\n  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan. Internally PostgreSQL:\n1. Acquires AccessExclusiveLock on pg_class\n2. Checks pg_class for existing relation named "users"\n3. If absent: creates heap file, adds pg_attribute entries,\n   creates btree index for PK, creates unique index for email\n4. If present: returns silently (IF NOT EXISTS)',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS \u2014 statement becomes a no-op instead of raising an error.' },
          { code: '42501', type: 'pg', label: 'insufficient_privilege', text: 'The DATABASE_URL role must have CREATE privilege on the target schema. Fails at startup if missing.' },
        ],
      },
      {
        id: 'DDL-02', category: 'ddl', op: 'CREATE TABLE',
        title: 'Create refresh_tokens table',
        desc: 'Creates the refresh_tokens table with a text primary key (the token itself), a foreign key to users.id with ON DELETE CASCADE, an expiration timestamp, and a creation timestamp.',
        sql: 'CREATE TABLE IF NOT EXISTS refresh_tokens (\n  token      TEXT        PRIMARY KEY,\n  user_id    UUID        NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  expires_at TIMESTAMPTZ NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Table created or no-op if exists',
        explain: 'DDL statement \u2014 no query plan.\n1. Creates heap + PK btree index on token column\n2. Adds FK constraint referencing users(id)\n3. Registers ON DELETE CASCADE trigger on users\n4. Must run AFTER DDL-01 (users table must exist)',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
          { code: '42830', type: 'pg', label: 'invalid_foreign_key', text: 'Raised if users table does not exist. Prevented by migration order (users created first).' },
        ],
      },
      {
        id: 'DDL-03', category: 'ddl', op: 'CREATE INDEX',
        title: 'Index on refresh_tokens(user_id)',
        desc: 'B-tree index for fast lookups when revoking all tokens for a specific user (logout-all-devices). Also benefits the CASCADE delete path.',
        sql: 'CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id\n  ON refresh_tokens(user_id);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Index created or no-op if exists',
        explain: 'Creates a B-tree index on the user_id column.\nUsed by: DML-04 (DELETE WHERE user_id = $1)\nWithout this index \u2192 Seq Scan on refresh_tokens\nWith this index    \u2192 Index Scan using idx_refresh_tokens_user_id\nComplexity: O(log n) lookups vs O(n) full scan',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-04', category: 'ddl', op: 'CREATE INDEX',
        title: 'Index on refresh_tokens(expires_at)',
        desc: 'B-tree index enabling efficient range scans for expired token cleanup. Supports future batch deletion queries.',
        sql: 'CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires_at\n  ON refresh_tokens(expires_at);',
        params: [],
        source: 'backend/src/migrations/001_init.sql',
        returns: 'Index created or no-op if exists',
        explain: 'Creates a B-tree index on the expires_at column.\nEnables: DELETE FROM refresh_tokens WHERE expires_at < NOW()\nPlan: Index Scan using idx_refresh_tokens_expires_at\n  \u2192 Filter: (expires_at < now())\nUseful for scheduled cleanup of expired tokens at scale.',
        errors: [
          { code: '42P07', type: 'pg', label: 'duplicate_table', text: 'Suppressed by IF NOT EXISTS.' },
        ],
      },
      {
        id: 'DDL-05', category: 'ddl', op: 'BATCH',
        title: 'Execute full migration script (initDb)',
        desc: 'Reads 001_init.sql from disk and executes all four DDL statements (DDL-01 through DDL-04) as a single query batch in one database round-trip. Called once on server startup.',
        sql: '-- File: 001_init.sql (executed as single batch)\n-- 1. CREATE TABLE IF NOT EXISTS users (...)\n-- 2. CREATE TABLE IF NOT EXISTS refresh_tokens (...)\n-- 3. CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id ...\n-- 4. CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires_at ...',
        params: [],
        source: 'backend/src/db.ts \u2192 initDb()',
        returns: 'No result rows',
        explain: 'Sends multi-statement SQL via pool.query(sql).\nPostgreSQL processes each statement sequentially\nwithin a single implicit transaction.\nAll IF NOT EXISTS guards make this safe for\nrepeated execution on every server restart.',
        errors: [
          { code: 'ECONNREFUSED', type: 'app', label: 'connection_refused', text: 'PostgreSQL is not running or DATABASE_URL is wrong. Server startup fails with an unhandled rejection.' },
          { code: '28P01', type: 'pg', label: 'invalid_password', text: 'DATABASE_URL credentials are incorrect. Connection is rejected before any DDL runs.' },
          { code: '3D000', type: 'pg', label: 'invalid_catalog_name', text: 'Database name in DATABASE_URL does not exist. Must be created first (docker-compose handles this).' },
        ],
      },

      // ── DML: INSERT ─────────────────────────────────────────────────────────
      {
        id: 'DML-01', category: 'dml', op: 'INSERT',
        title: 'Insert new user (registration)',
        desc: 'Inserts a new user with a lowercased email and scrypt password hash. RETURNING eliminates a second SELECT round-trip. On duplicate email, PostgreSQL raises 23505 which the app catches and maps to HTTP 409.',
        sql: 'INSERT INTO users (email, password_hash)\nVALUES ($1, $2)\nRETURNING id, email, password_hash;',
        params: [
          { idx: '$1', name: 'email', type: 'TEXT', desc: 'User email, lowercased via email.toLowerCase() before query' },
          { idx: '$2', name: 'passwordHash', type: 'TEXT', desc: 'Scrypt hash string in salt:derivedKey hex format' },
        ],
        source: 'backend/src/userStore.ts \u2192 createUser()',
        returns: '{ id: UUID, email: TEXT, password_hash: TEXT }',
        explain: 'Insert on Conflict: uses unique index on email column\n\nPlan: Insert on users\n  \u2192 Result (generates row with gen_random_uuid())\n  \u2192 Constraint check: users_email_key (UNIQUE)\n  \u2192 If passes: insert heap tuple, update PK + UNIQUE indexes\n  \u2192 If violates: raise 23505 unique_violation\n\nCost: single index probe on email + heap insert\nReturning: avoids separate SELECT by returning in same statement',
        errors: [
          { code: '23505', type: 'pg', label: 'unique_violation', text: 'Email already exists. Caught in createUser() catch block \u2192 throws Error("email_taken") \u2192 route returns <strong>HTTP 409</strong> { error: "Email already registered", code: "email_taken" }' },
          { code: '23502', type: 'pg', label: 'not_null_violation', text: 'Would fire if $1 or $2 is null. Prevented by Zod schema validation in the auth route before the query runs.' },
          { code: 'ECONNREFUSED', type: 'app', label: 'pool_error', text: 'Pool cannot connect. Bubbles up as 500 to the global error handler.' },
        ],
      },
      {
        id: 'DML-02', category: 'dml', op: 'INSERT',
        title: 'Insert refresh token',
        desc: 'Stores a new refresh token with a 7-day TTL computed server-side by PostgreSQL. The token is a crypto-random 32-byte hex string from Node.js crypto.randomBytes().',
        sql: "INSERT INTO refresh_tokens (token, user_id, expires_at)\nVALUES ($1, $2, NOW() + interval '7 days');",
        params: [
          { idx: '$1', name: 'token', type: 'TEXT', desc: '64-char hex string from crypto.randomBytes(32).toString("hex")' },
          { idx: '$2', name: 'userId', type: 'UUID', desc: 'User UUID from users.id (returned by DML-01 or DQL-01)' },
        ],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 createRefreshToken()',
        returns: 'No result rows (INSERT without RETURNING)',
        explain: "Plan: Insert on refresh_tokens\n  \u2192 Result (evaluates NOW() + interval '7 days')\n  \u2192 Constraint check: refresh_tokens_pkey (PK on token)\n  \u2192 FK check: users_pkey (verifies user_id exists)\n  \u2192 Insert heap tuple, update PK + user_id + expires_at indexes\n\nServer-side NOW() avoids clock-skew between Node.js and PostgreSQL.\nThe 64-char hex token has 2\u00b9\u2076\u2078 possible values \u2192 collision probability \u2248 0.",
        errors: [
          { code: '23505', type: 'pg', label: 'unique_violation', text: 'Token collision (astronomically unlikely with 256-bit random). Would cause a 500 error. In practice, never occurs.' },
          { code: '23503', type: 'pg', label: 'foreign_key_violation', text: 'user_id does not exist in users table. Prevented by the auth flow: user must exist before tokens are created.' },
        ],
      },

      // ── DML: DELETE ─────────────────────────────────────────────────────────
      {
        id: 'DML-03', category: 'dml', op: 'DELETE',
        title: 'Consume refresh token (atomic rotation)',
        desc: 'Atomically deletes a refresh token and returns its owner in one statement. The token is destroyed on use, preventing replay attacks. Application checks expires_at after deletion \u2014 even expired tokens are always deleted.',
        sql: 'DELETE FROM refresh_tokens\nWHERE token = $1\nRETURNING user_id, expires_at;',
        params: [
          { idx: '$1', name: 'token', type: 'TEXT', desc: 'Refresh token string extracted from the httpOnly cookie' },
        ],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 consumeRefreshToken()',
        returns: '{ user_id: UUID, expires_at: TIMESTAMPTZ } or empty rowset',
        explain: 'Plan: Delete on refresh_tokens\n  \u2192 Index Scan using refresh_tokens_pkey\n        Index Cond: (token = $1)\n  \u2192 Delete heap tuple + remove from all 3 indexes\n  \u2192 Return deleted row data via RETURNING\n\nCost: O(1) \u2014 PK lookup is a single btree probe.\nAtomicity: DELETE + RETURNING is a single statement,\nso concurrent requests cannot both consume the same token.\nEven if the token is expired, it is deleted to prevent reuse.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'Token not found (invalid or already consumed). Function returns <code>null</code> \u2192 route returns <strong>HTTP 401</strong> { error: "Invalid or expired refresh token", code: "invalid_refresh_token" }' },
          { code: '\u2014', type: 'app', label: 'expires_at < now', text: 'Token found but expired. Row is still deleted (preventing reuse), but function returns <code>null</code> \u2192 same 401 response.' },
        ],
      },
      {
        id: 'DML-04', category: 'dml', op: 'DELETE',
        title: 'Revoke all tokens for user (logout)',
        desc: 'Deletes every refresh token for a given user, effectively logging them out of all devices. Uses the idx_refresh_tokens_user_id index for efficient lookup.',
        sql: 'DELETE FROM refresh_tokens\nWHERE user_id = $1;',
        params: [
          { idx: '$1', name: 'userId', type: 'UUID', desc: 'User UUID whose sessions should be terminated' },
        ],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 revokeAllRefreshTokensForUser()',
        returns: 'No result rows consumed',
        explain: 'Plan: Delete on refresh_tokens\n  \u2192 Index Scan using idx_refresh_tokens_user_id\n        Index Cond: (user_id = $1)\n  \u2192 Delete matching heap tuples + update indexes\n\nCost: O(log n + k) where k = number of tokens for this user.\nTypically k = 1\u20133 (one per device).\nWithout the index: Seq Scan \u2192 O(n) full table scan.',
        errors: [
          { code: '\u2014', type: 'app', label: 'no rows deleted', text: 'If the user has no tokens, DELETE succeeds with 0 rows affected. This is not an error \u2014 the function returns void.' },
        ],
      },

      // ── DML: TRUNCATE ───────────────────────────────────────────────────────
      {
        id: 'DML-05', category: 'dml', op: 'TRUNCATE',
        title: 'Truncate users table (test cleanup)',
        desc: 'Removes all rows from users. CASCADE propagates to refresh_tokens via the FK, so both tables are emptied in one statement. Used exclusively in test teardown.',
        sql: 'TRUNCATE TABLE users CASCADE;',
        params: [],
        source: 'backend/src/userStore.ts \u2192 resetUserStoreForTests()',
        returns: 'No result rows',
        explain: 'TRUNCATE vs DELETE:\n  DELETE  \u2192 row-by-row, fires triggers, generates WAL per row\n  TRUNCATE \u2192 deallocates pages, resets sequence, minimal WAL\n\nCASCADE: PostgreSQL follows FK dependency graph\n  and truncates refresh_tokens automatically.\n\nSpeed: O(1) regardless of row count (no scanning).\nCaveat: acquires AccessExclusiveLock on both tables.',
        errors: [
          { code: '0A000', type: 'pg', label: 'feature_not_supported', text: 'Cannot TRUNCATE a table referenced by an FK without CASCADE. Here CASCADE is always specified, so this never fires.' },
        ],
      },
      {
        id: 'DML-06', category: 'dml', op: 'TRUNCATE',
        title: 'Truncate refresh_tokens table (test cleanup)',
        desc: 'Removes all rows from refresh_tokens independently of users. Allows tests to clear tokens while keeping user accounts intact.',
        sql: 'TRUNCATE TABLE refresh_tokens;',
        params: [],
        source: 'backend/src/auth/refreshTokenStore.ts \u2192 resetRefreshTokenStoreForTests()',
        returns: 'No result rows',
        explain: 'Same O(1) performance as DML-05.\nNo CASCADE needed because refresh_tokens\nhas no dependent foreign keys pointing to it.\nAcquires AccessExclusiveLock on refresh_tokens only.',
        errors: [],
      },

      // ── DQL: SELECT ─────────────────────────────────────────────────────────
      {
        id: 'DQL-01', category: 'dql', op: 'SELECT',
        title: 'Find user by email (login)',
        desc: 'Retrieves a single user row by email for credential verification. The email is lowercased before the query for case-insensitive matching. Returns the password hash for scrypt comparison.',
        sql: 'SELECT id, email, password_hash\nFROM users\nWHERE email = $1;',
        params: [
          { idx: '$1', name: 'email', type: 'TEXT', desc: 'User email, lowercased via email.toLowerCase() before query' },
        ],
        source: 'backend/src/userStore.ts \u2192 findUserByEmail()',
        returns: '{ id: UUID, email: TEXT, password_hash: TEXT } or empty rowset',
        explain: 'Plan: Index Scan using users_email_key\n  Index Cond: (email = $1)\n  \u2192 Fetches single heap tuple via UNIQUE index\n\nCost: O(1) \u2014 single btree probe on the UNIQUE index.\nThe UNIQUE constraint guarantees at most 1 row returned.\nNo Seq Scan possible because the planner always\nchooses the unique index for equality predicates.',
        errors: [
          { code: '\u2014', type: 'app', label: 'rows.length === 0', text: 'User not found. Function returns <code>undefined</code> \u2192 route returns <strong>HTTP 401</strong> { error: "Invalid credentials", code: "invalid_credentials" }. Error intentionally does not reveal whether email or password was wrong.' },
        ],
      },
    ];

    /* ======================================================================= */
    /*  RENDER HELPERS                                                         */
    /* ======================================================================= */
    const listEl     = document.getElementById('query-list');
    const qiGrid     = document.getElementById('qi-grid');
    const countLabel  = document.getElementById('count-label');
    const statsEl     = document.getElementById('stats');
    const searchInput = document.getElementById('search');

    const CAT_LABELS = { ddl: 'DDL', dml: 'DML', dql: 'DQL' };
    const CAT_BADGE  = { ddl: 'badge-ddl', dml: 'badge-dml', dql: 'badge-dql' };
    const OP_CLASS   = {
      SELECT: 'op-select', INSERT: 'op-insert', DELETE: 'op-delete',
      'CREATE TABLE': 'op-create', 'CREATE INDEX': 'op-create',
      BATCH: 'op-create', TRUNCATE: 'op-truncate',
    };
    const ERR_TYPE_CLASS = { pg: 'error-code-pg', http: 'error-code-http', app: 'error-code-app' };

    // ── Stats ─────────────────────────────────────────────────────────────────
    const total = QUERIES.length;
    const ddlCount = QUERIES.filter(q => q.category === 'ddl').length;
    const dmlCount = QUERIES.filter(q => q.category === 'dml').length;
    const dqlCount = QUERIES.filter(q => q.category === 'dql').length;
    const paramCount = QUERIES.reduce((s, q) => s + q.params.length, 0);

    statsEl.innerHTML = `
      <div class="stat"><strong>${total}</strong>Queries</div>
      <div class="stat"><strong>${ddlCount}</strong>DDL</div>
      <div class="stat"><strong>${dmlCount}</strong>DML</div>
      <div class="stat"><strong>${dqlCount}</strong>DQL</div>
      <div class="stat"><strong>${paramCount}</strong>Bind params</div>
      <div class="stat"><strong>0</strong>Raw SQL concat</div>
    `;

    // ── SQL Syntax Highlighting ───────────────────────────────────────────────
    function hl(raw) {
      return raw
        .replace(/(--[^\n]*)/g, '<span class="cmt">$1</span>')
        .replace(/\b(CREATE TABLE|CREATE INDEX|IF NOT EXISTS|PRIMARY KEY|DEFAULT|UNIQUE|NOT NULL|REFERENCES|ON DELETE CASCADE|INSERT INTO|VALUES|RETURNING|DELETE FROM|WHERE|SELECT|FROM|TRUNCATE TABLE|CASCADE|AND|OR|SET|BATCH)\b/gi, '<span class="kw">$1</span>')
        .replace(/\b(gen_random_uuid|NOW|interval)\b/gi, '<span class="fn">$1</span>')
        .replace(/\b(UUID|TEXT|TIMESTAMPTZ|BOOLEAN|INTEGER)\b/g, '<span class="type">$1</span>')
        .replace(/\b(users|refresh_tokens)\b/g, '<span class="tbl">$1</span>')
        .replace(/'([^']*)'/g, "'<span class=\"str\">$1</span>'")
        .replace(/(\$\d+)/g, '<span class="param">$1</span>');
    }

    function hlExplain(raw) {
      return raw
        .replace(/\b(Index Scan|Seq Scan|Insert|Delete|Result|Filter|Index Cond|Constraint check|Plan|Cost|FK check)\b/g, '<span class="ex-node">$1</span>')
        .replace(/(O\([^)]+\))/g, '<span class="ex-cost">$1</span>')
        .replace(/\b(idx_\w+|users_email_key|refresh_tokens_pkey)\b/g, '<span class="ex-note">$1</span>');
    }

    // ── Query Index ───────────────────────────────────────────────────────────
    function buildIndex() {
      qiGrid.innerHTML = QUERIES.map((q, i) => `
        <a class="qi-item" data-target="${i}">
          <span class="qi-id">${q.id}</span>
          <span class="qi-title">${q.title}</span>
          <span class="qi-op op-badge ${OP_CLASS[q.op] || ''}">${q.op}</span>
        </a>
      `).join('');
    }
    buildIndex();

    // Jump to card on index click
    qiGrid.addEventListener('click', (e) => {
      const item = e.target.closest('.qi-item');
      if (!item) return;
      const idx = parseInt(item.dataset.target);
      const card = document.querySelector(`.query-card[data-idx="${idx}"]`);
      if (!card) return;

      // close all, open target
      document.querySelectorAll('.query-card.open').forEach(c => c.classList.remove('open'));
      card.classList.add('open');
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // brief highlight
      card.classList.add('highlight');
      setTimeout(() => card.classList.remove('highlight'), 1500);
    });

    // ── Build Query Cards ─────────────────────────────────────────────────────
    function buildCards() {
      listEl.innerHTML = QUERIES.map((q, i) => `
        <div class="query-card" data-idx="${i}" data-category="${q.category}" id="q-${q.id}">
          <div class="query-header" data-idx="${i}">
            <span class="query-chevron">&#9654;</span>
            <span class="query-id">${q.id}</span>
            <span class="query-title">${q.title}</span>
            <div class="query-meta">
              <span class="badge ${CAT_BADGE[q.category]}">${CAT_LABELS[q.category]}</span>
              <span class="op-badge ${OP_CLASS[q.op] || ''}">${q.op}</span>
            </div>
          </div>
          <div class="query-body">
            <div class="query-desc">${q.desc}</div>

            <div class="sql-block"><button class="copy-btn" data-idx="${i}">Copy</button>${hl(q.sql)}</div>

            ${q.params.length > 0 ? `
            <div class="detail-field" style="margin-bottom:14px">
              <span class="detail-label">Bind Parameters</span>
              <div class="detail-value" style="padding:0; overflow:hidden">
                <table class="param-table">
                  <thead><tr><th>Param</th><th>Name</th><th>Type</th><th>Description</th></tr></thead>
                  <tbody>
                    ${q.params.map(p => `<tr>
                      <td><span class="param-idx">${p.idx}</span></td>
                      <td><span class="param-name">${p.name}</span></td>
                      <td><span class="param-type">${p.type}</span></td>
                      <td>${p.desc}</td>
                    </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>` : ''}

            <div class="detail-grid">
              <div class="detail-field">
                <span class="detail-label">Returns</span>
                <div class="detail-value"><code>${q.returns}</code></div>
              </div>
              <div class="detail-field">
                <span class="detail-label">Source File</span>
                <div class="detail-value"><code>${q.source}</code></div>
              </div>

              <div class="detail-field full">
                <span class="detail-label">Execution Plan &amp; Performance</span>
                <div class="explain-block">${hlExplain(q.explain)}</div>
              </div>

              ${q.errors.length > 0 ? `
              <div class="detail-field full">
                <span class="detail-label">Error Handling</span>
                <div class="detail-value" style="padding:8px">
                  <ul class="error-list">
                    ${q.errors.map(e => `<li class="error-item">
                      <span class="error-code ${ERR_TYPE_CLASS[e.type] || 'error-code-app'}">${e.code}</span>
                      <span class="error-text">${e.text}</span>
                    </li>`).join('')}
                  </ul>
                </div>
              </div>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }
    buildCards();

    /* ======================================================================= */
    /*  INTERACTIVITY                                                          */
    /* ======================================================================= */

    // Expand / collapse
    listEl.addEventListener('click', (e) => {
      if (e.target.closest('.copy-btn')) return;
      const header = e.target.closest('.query-header');
      if (!header) return;

      const card = header.closest('.query-card');
      const wasOpen = card.classList.contains('open');

      document.querySelectorAll('.query-card.open').forEach(c => c.classList.remove('open'));
      if (!wasOpen) card.classList.add('open');
    });

    // Copy button
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.copy-btn');
      if (!btn) return;
      e.stopPropagation();
      const idx = parseInt(btn.dataset.idx);
      navigator.clipboard.writeText(QUERIES[idx].sql).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
      });
    });

    // Filter tabs
    let activeFilter = 'all';
    document.getElementById('filters').addEventListener('click', (e) => {
      const tab = e.target.closest('.tab');
      if (!tab) return;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      activeFilter = tab.dataset.filter;
      applyFilters();
    });

    // Search
    searchInput.addEventListener('input', () => applyFilters());

    function applyFilters() {
      const q = searchInput.value.toLowerCase().trim();
      let visible = 0;

      document.querySelectorAll('.query-card').forEach(card => {
        const idx = parseInt(card.dataset.idx);
        const query = QUERIES[idx];

        const matchCat = activeFilter === 'all' || query.category === activeFilter;
        const matchSearch = !q ||
          query.id.toLowerCase().includes(q) ||
          query.title.toLowerCase().includes(q) ||
          query.desc.toLowerCase().includes(q) ||
          query.sql.toLowerCase().includes(q) ||
          query.op.toLowerCase().includes(q);

        const show = matchCat && matchSearch;
        card.style.display = show ? '' : 'none';
        if (show) visible++;
      });

      countLabel.textContent = `${visible} of ${total}`;
    }

    applyFilters();

    // Open card if URL has hash like #q-DML-01
    if (location.hash && location.hash.startsWith('#q-')) {
      const el = document.getElementById(location.hash.slice(1));
      if (el) {
        el.classList.add('open');
        setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
      }
    }
    </script>
  </body>
</html>
