# Безопасность и комплаенс iGaming платформы

Угрозы, меры защиты и соответствие регуляторным требованиям (penetration testing & security architecture).

---

## 1. УГРОЗЫ И АТАКИ

### 1.1 Replay Attack

**Суть**: злоумышленник перехватывает успешный запрос POST /spin (включая заголовки и тело), затем повторяет его без изменений. Цель — получить повторное зачисление выигрыша или повторный спин без списания ставки.

**Векторы**:
- Перехват трафика (MITM при отсутствии TLS или компрометация клиента).
- Копирование запроса из DevTools/Proxy (Har, curl) и повторная отправка.

**Риск**: двойное списание/зачисление, искажение баланса и аудита.

---

### 1.2 Race Condition (двойной спин с одним балансом)

**Суть**: пользователь или скрипт отправляет два (или более) запроса POST /spin почти одновременно. Оба проходят проверку «баланс >= bet» до того, как любой из них успеет списать средства. В результате списывается только одна ставка, но исполняются два спина, или списываются две ставки при недостаточном балансе → отрицательный баланс.

**Векторы**:
- Двойной клик по кнопке SPIN.
- Параллельные запросы из скрипта (Promise.all с двумя /spin).
- Автоспин с обходом блокировки UI на клиенте.

**Риск**: эксплуатация баланса, отрицательный баланс, рассинхрон с БД и транзакциями.

---

### 1.3 Parameter Tampering

**Суть**: изменение параметров запроса на стороне клиента или через прокси: `bet_amount`, `session_id`, `game_id`, `currency`, `lines` и т.д.

**Примеры**:
- Увеличение `bet_amount` в надежде, что сервер не проверит лимиты или не сопоставит с балансом.
- Подмена `session_id` для игры от имени другой сессии.
- Уменьшение `bet_amount` до нуля или копеек при сохранении выплат по полной ставке (если сервер доверяет клиенту).
- Изменение `game_id` на более выгодный по RTP/бонусам.

**Риск**: обход лимитов, чужие сессии, манипуляция выплатами, мошенничество.

---

### 1.4 JWT Manipulation

**Алгоритм "none"**: в заголовке JWT указывают `"alg": "none"` и убирают подпись. Некоторые старые библиотеки при неверной конфигурации принимают такой токен как валидный и доверяют содержимому (sub, session_id), что позволяет выдать себя за другого пользователя.

**Brute force secret**: при использовании симметричного алгоритма (HS256) секрет подписи можно подбирать. Если секрет слабый или скомпрометирован, атакующий может подделывать токены с произвольным `sub` (user_id).

**Подмена claims**: без проверки подписи или при сломанной проверке — изменение `sub`, `session_id`, `role` в payload.

**Риск**: полная компрометация аутентификации, доступ под чужим аккаунтом, манипуляция сессиями.

---

### 1.5 IDOR (Insecure Direct Object Reference)

**Суть**: доступ к объектам другого пользователя по подбору или угадыванию идентификатора.

**Примеры**:
- GET /api/v1/history?user_id=12345 — возврат истории другого пользователя при отсутствии проверки «текущий user_id == 12345».
- GET /api/v1/spin/{spin_id} с spin_id другого пользователя — утечка outcome, ставки, баланса.
- GET /api/v1/session/{session_id} — доступ к чужой сессии.

**Риск**: утечка PII, истории ставок и выигрышей, нарушение конфиденциальности и GDPR.

---

### 1.6 Negative Balance Exploit

**Суть**: выполнение спина при нулевом или недостаточном балансе за счёт гонки, бага в проверке или кэширования устаревшего баланса.

**Векторы**:
- Race: два спина одновременно, оба видят старый баланс.
- Отправка спина с отрицательной ставкой в надежде на ошибку в коде (win - bet даёт прирост при bet < 0).
- Использование устаревшего ответа (replay) с прежним балансом после вывода средств.

**Риск**: кредитование игрока без депозита, финансовые потери платформы, нарушения лицензии.

---

### 1.7 Client-Side Outcome Manipulation

**Суть**: попытка изменить отображаемый или «принятый» результат спина на клиенте.

**Векторы**:
- Подмена ответа API в прокси/DevTools (подставить свой reel_matrix и большой win). Если клиент только отображает ответ и не сверяет его с сервером повторно — пользователь видит фейковый выигрыш; критично, если где-то баланс обновляется из клиентских данных.
- Изменение JS: перехват ответа и подмена поля `win.amount` перед записью в store, чтобы показать неверный баланс (при условии, что бэкенд не является единственным источником правды).
- Манипуляция с отправкой «подтверждения» выигрыша на сервер (если такая логика ошибочно есть).

**Риск**: при правильной архитектуре (баланс и outcome только с сервера) — только визуальный обман; при ошибках в дизайне — возможна попытка повлиять на учёт выплат.

---

## 2. ЗАЩИТА

### 2.1 Idempotency Keys для каждого spin-запроса

**Цель**: предотвратить повторное исполнение одного и того же спина (replay и случайные дубликаты).

**Реализация**:
- Клиент генерирует уникальный ключ на каждый запрос спина: `Idempotency-Key: <uuid>` (или комбинация session_id + client_timestamp + nonce).
- Сервер хранит ключ в кэше/БД (Redis или таблица `idempotency_keys`: key, user_id, response_snapshot, created_at) с TTL (например 24 часа).
- При первом запросе с ключом — выполнить спин, сохранить ответ, записать ключ.
- При повторном запросе с тем же ключом — вернуть **тот же сохранённый ответ** без повторного спина (HTTP 200 с тем же телом).
- Запросы без ключа можно отклонять (422) или не гарантировать идемпотентность.

**Защита от**: Replay Attack, двойная отправка из-за двойного клика или сетевых повторов.

---

### 2.2 Server-Side Validation ВСЕХ параметров ставки

**Принцип**: сервер не доверяет ни одному параметру от клиента для бизнес-логики. Всё перепроверяется и берётся из своих источников.

**Проверки для POST /spin**:
- **bet.amount**: в границах min_bet и max_bet для данной игры (из конфига на сервере); тип — число, не строка; округление по правилам валюты.
- **bet.currency**: совпадает с валютой пользователя/сессии (из БД).
- **bet.lines**: допустимое значение для игры (например фиксировано 20 или из списка).
- **session_id**: принадлежит текущему user_id (из JWT); сессия активна, не истекла.
- **game_id**: разрешён для платформы и юрисдикции; конфиг игры загружается сервером.
- **balance**: достаточность баланса получать из БД после блокировки (см. ниже), а не из запроса.

**Ответ при ошибке**: 422 Unprocessable Entity с кодом (e.g. `INVALID_BET`, `BET_BELOW_MIN`) без исполнения спина.

---

### 2.3 Database-Level Pessimistic Locking баланса

**Цель**: исключить race condition при списании и зачислении.

**Реализация**:
- При обработке спина: в одной транзакции выполнить `SELECT ... FROM balances WHERE user_id = ? AND currency = ? FOR UPDATE` (pessimistic lock).
- Проверить `balance >= bet_amount`; если нет — откат, ответ 422.
- Списать ставку (UPDATE balances SET amount = amount - bet, version = version + 1).
- Записать спин и транзакции (bet transaction).
- После расчёта outcome — зачислить выигрыш (UPDATE balances), записать win transaction.
- Commit транзакции.

**Эффект**: второй одновременный спин того же пользователя будет ждать lock и увидит уже обновлённый баланс — отказ при недостатке средств или один спин на одну «единицу» баланса.

**Дополнительно**: optimistic locking по `version` на таблице balances для обнаружения конфликтов при редких сценариях (например депозит в другой транзакции).

---

### 2.4 JWT: RS256 + Short Expiry + Refresh Token Rotation

- **RS256 (или ES256)**: подпись JWT — асимметричная. Сервер подписывает приватным ключом, проверяет публичным. Подделать токен без приватного ключа невозможно; brute force секрета не применим (секрета нет на стороне проверяющего).
- **Short expiry access token**: например 5–15 минут. Ограничивает окно использования украденного токена.
- **Refresh token**: долгоживущий токен (хранится в БД или подписан отдельным секретом), одноразовый или с семейством. Используется только для получения новой пары access + refresh. После использования refresh токен инвалидируется (rotation). При компрометации — отзыв по списку или по семейству.
- **Запрет "alg": "none"**: в библиотеке явно задать список допустимых алгоритмов (например только RS256). Отклонять токены с `alg: none` или без подписи.

---

### 2.5 Rate Limiting: max N спинов в секунду на user_id

**Цель**: снизить ущерб от ботов, скриптов и случайных лавин запросов; смягчить brute force и перебор.

**Реализация**:
- Счётчик запросов к POST /spin (и при необходимости POST /bonus/trigger) по ключу `user_id` (или `session_id`) в скользящем окне или фиксированном окне (например 1 секунда).
- Лимит: например не более 2–5 спинов в секунду на пользователя. При превышении — **429 Too Many Requests** с Retry-After.
- Хранение счётчиков: Redis (INCR, EXPIRE) или аналог.

**Дополнительно**: глобальный rate limit по IP для неаутентифицированных и по endpoint для защиты от DDoS.

---

### 2.6 HMAC Signature запросов (spin_id + timestamp + secret)

**Назначение**: дополнительная целостность и анти-replay для критичных запросов (опциональный слой поверх TLS и idempotency).

**Идея**:
- Сервер после спина возвращает подпись: `HMAC-SHA256(secret, spin_id || timestamp)` в заголовке или в теле.
- Клиент при следующих запросах (например при запросе истории или подтверждении) может отправлять эту подпись для привязки к конкретному спину.
- Для входящих запросов спина: клиент может подписывать `Idempotency-Key + timestamp` и отправлять заголовок `X-Request-Signature`; сервер проверяет подпись и отклоняет при неверной или устаревшей метке времени (ограничение окна replay).

**Ограничение**: секрет для подписи должен быть на клиенте осторожно (встроенный в приложение всё равно извлекаем). Имеет смысл для запросов server-to-server или для проверки ответов сервера клиентом; для браузера приоритет — idempotency, TLS, серверная валидация.

---

### 2.7 Certified RNG Audit (BMM, GLI, eCOGRA)

**Цель**: доказать регуляторам и операторам, что RNG и игровая математика соответствуют стандартам честной игры и не поддаются манипуляции.

**Практика**:
- Использование сертифицированного генератора (например Mersenne Twister) и документированная seed generation.
- Аудит кода и тесты третьей стороной: BMM Compliance, GLI (Gaming Laboratories International), eCOGRA и т.д. — проверка распределения, отсутствия смещения, воспроизводимости по seed.
- Логирование seed (или его хэша) и spin_id для последующей верификации результата.
- Документация по RTP, volatility и paytable для каждой игры.

**Защита от**: обвинений в манипуляции результатами, отзыва лицензии; повышение доверия партнёров.

---

## 3. COMPLIANCE

### 3.1 Responsible Gambling (RG)

**Лимиты** (настраиваемые пользователем или обязательные по юрисдикции):
- **Deposit limit**: максимум депозита за день/неделю/месяц.
- **Loss limit**: максимум проигрыша за период.
- **Session limit**: время непрерывной игры с напоминанием или принудительным выходом.
- **Bet limit**: максимум ставки на спин (может совпадать с max_bet игры или быть ниже).

**Реализация**: проверки при депозите и при установке ставки на спин; блокировка превышения на уровне API и БД.

**Самоисключение (self-exclusion)**:
- Пользователь может добровольно заблокировать доступ на срок (месяц, полгода, год, навсегда).
- В БД: статус пользователя (например `self_excluded`) и дата окончания. При логине и при каждом критичном действии (спин, депозит) — проверка; при активном самоисключении — отказ (403) и редирект на страницу RG.
- Интеграция с национальными реестрами (например GAMSTOP в UK), где требуется — проверка при регистрации.

**Дополнительно**: предупреждения о рисках, ссылки на помощь (GamCare, BeGambleAware), отображение времени сессии и проигрыша в HUD.

---

### 3.2 AML (Anti-Money Laundering)

**Мониторинг подозрительных паттернов**:
- Необычно высокие ставки или объём игр относительно истории пользователя.
- Быстрые циклы депозит → игра → вывод (layering).
- Игра с нескольких устройств/IP из разных стран в короткий период.
- Структурирование (много мелких депозитов ниже порога отчётности).
- Выигрыши, не соответствующие типичному RTP (крайние выбросы — редко, но возможны; массовые аномалии — сигнал).

**Действия**:
- KYC (верификация личности) при превышении лимитов или при выводе выше порога.
- Флаги в системе: риск-скоринг по правилам (правила на основе регулятора); эскалация в compliance team.
- Логирование транзакций и игровых событий для отчётов и расследований.
- SAR (Suspicious Activity Report) в финансовый мониторинг по юрисдикции.

---

### 3.3 GDPR и хранение данных спинов

**Принципы**:
- **Lawfulness, fairness, transparency**: явное согласие/договор на обработку игровых данных; политика конфиденциальности с указанием целей (исполнение договора, лицензионные требования, AML).
- **Purpose limitation**: данные спинов хранятся для исполнения договора, аудита, регуляторных требований и AML; не используются для несвязанных целей без основания.
- **Data minimisation**: хранить только необходимые поля (user_id, spin_id, bet, win, outcome, timestamp); не хранить лишние PII в логах спинов.
- **Storage limitation**: срок хранения — по закону и лицензии (часто 5–10 лет для транзакций и игровой истории); после — удаление или анонимизация.
- **Integrity and confidentiality**: шифрование БД и бэкапов, доступ по ролям, аудит доступа.

**Права субъекта**:
- **Access**: пользователь может запросить копию своей истории спинов (экспорт в машинно-читаемом формате).
- **Rectification**: исправление неточностей персональных данных (игровая история обычно не подлежит изменению по закону; уточняются профильные данные).
- **Erasure**: «право на забвение» с ограничениями — игровые и финансовые данные могут подлежать хранению по закону (налог, AML, лицензия); удаление там, где закон разрешает.
- **Portability**: предоставление истории в структурированном формате (JSON/CSV) по запросу.

**Документация**: реестр обработки (ROPA), DPA с партнёрами, процедуры реагирования на утечки (уведомление надзора и пользователей в сроки по GDPR).

---

## Сводная таблица: угроза → защита

| Угроза                    | Меры защиты |
|---------------------------|-------------|
| Replay Attack             | Idempotency keys, HMAC + timestamp window (опц.) |
| Race Condition            | Pessimistic locking баланса, одна транзакция на спин |
| Parameter Tampering       | Server-side validation всех параметров, лимиты из конфига/БД |
| JWT manipulation          | RS256, запрет "none", short expiry, refresh rotation |
| IDOR                      | Проверка ownership: user_id из JWT, фильтр по текущему пользователю |
| Negative balance          | Lock + проверка баланса в транзакции, отказ при bet > balance |
| Client-side manipulation  | Outcome и баланс только с сервера, клиент только отображение |
| Brute force / abuse       | Rate limiting по user_id/session_id, лимит спинов в секунду |
| RNG/честность игры        | Certified RNG (BMM, GLI, eCOGRA), аудит и логирование seed |

Комплаенс (RG, AML, GDPR) обеспечивается политиками, лимитами в коде, мониторингом и процедурами, а не одной технической мерой.
